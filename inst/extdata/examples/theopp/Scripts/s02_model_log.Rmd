---
title: "model development"
author: "`r Sys.info()['user']`"
date: "`r Sys.time()`"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---


```{r setup, include=F}
## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
library(rprojroot)
library(knitr)
opts_knit$set(root.dir=find_root(has_file('.Rprofile')))
opts_chunk$set(echo = TRUE)
opts_chunk$set(message = TRUE)
```

```{r echo=FALSE,message=FALSE}
## LOAD PACKAGES HERE

library(NMproject)
library(future)
future::plan("future::multiprocess", workers = 2)
library(dplyr)

load_localpackage()

```

## model development

```{r}

m1 <- new_nm(run_id = "m1",
             based_on = "staging/Models/run1.mod",
             data_path = "DerivedData/data.csv") %>%
  cmd("execute {ctl_name} -dir={run_dir}") %>%
  fill_input(rename = c("DAT0" = "DATE")) %>%
  run_nm()
  
```

```{r}
m1 %>% nm_render("Scripts/basic_gof.Rmd")
```

```{r}
## simulation for ppc and vpc

m1s <- m1 %>% child("m1s") %>%
  update_parameters(m1) %>%
  convert_to_simulation(subpr = 20) %>%
  run_nm()

```

```{r}

m1s %>% nm_render("Scripts/basic_ppc.Rmd")
m1s %>% nm_render("Scripts/basic_vpc.Rmd")

```


```{r}

m1 %>% saveRDS("Results/m1.RDS")

m2 <- m1 %>% child("m2") %>%
  subroutine(trans = 2) %>% 
  run_nm()

m2WT <- m2 %>% child("m2WT") %>%
  add_cov(param = "CL", cov = "WT", state = "linear") %>%
  run_nm()

c(m2, m2WT) %>% nm_render("Scripts/basic_gof.Rmd")

```

Body weight not signficant.  K parameterisation better than CL in terms of OFV

```{r}

kable(summary_long(c(m2, m2WT), parameters = "all"))
kable(rr(c(m2, m2WT)))

```

### example bootstrap

```{r}
m1_boot <- m1 %>% 
  make_boot_datasets(samples = 10, overwrite = TRUE)

m1_boot$m <- m1_boot$m %>% run_nm()

m1_boot$m %>% nm_list_render("Scripts/basic_boot.Rmd")

```

### example bootstrap cross-validation

```{r}

m1_xv <- m1_boot %>% 
  make_xv_datasets() %>%
  mutate(m_xv = m_xv %>%
           update_parameters(m1_boot$m) %>%
           dollar("EST",
                  "$EST METHOD=IMP INTER EONLY= 1 MAPITER=0 ISAMPLE = 2000 NITER = 10 RANMETHOD=3S2 NOABORT PRINT=1 NSIG=3 SIGL=9"))

m1_xv$m_xv %>% run_nm()

m1_xv$m_xv %>% 
  subset(status(.) %in% "finished") %>% 
  ofv() %>% 
  mean() ## xv-ofv - to be used for xv model selection

```


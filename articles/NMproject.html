<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NMproject • NMproject</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NMproject">
<meta property="og:description" content="NMproject">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NMproject</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.9.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/NMproject.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tsahota/NMproject/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="NMproject_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>NMproject</h1>
                        <h4 class="author">Tarj Sahota</h4>
            
            <h4 class="date">2021-04-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tsahota/NMproject/blob/master/vignettes/NMproject.Rmd"><code>vignettes/NMproject.Rmd</code></a></small>
      <div class="hidden name"><code>NMproject.Rmd</code></div>

    </div>

    
    
<div id="why-nmproject" class="section level2">
<h2 class="hasAnchor">
<a href="#why-nmproject" class="anchor"></a>Why NMproject?</h2>
<p>NMproject’s initial outing (the alpha interface) was developed in AZ and internally had 83% voluntary user retention (“user” = someone with 5+ separate model development workflows). NMproject’s main objective is industrialisation via script based model development.</p>
<p>The beta interface is a completely new syntax that address several shortcoming of the previous syntax and expands functionality.</p>
<p>So why NMproject?</p>
<ul>
<li><p>Go from code library templates (shiny interface) to a working parent NONMEM model quickly and entirely within R. See demo.</p></li>
<li><p>Use R functions and tracked manual editing to create NONMEM runs. NMproject is the only NONMEM interface (that I know of) that tracks manual edits to NONMEM code in the form of reusable patches. It is also the only R package (that I know of) with a vectorized model object allowing single runs to be handled in the same way as groups of runs.</p></li>
<li><p>Create end-to-end model development workflows entirely within R without any additional effort. Run caching encourages you to re-execute scripts and rebuild objects frequently to ensure your workflow contains no reproduciblity breaks. Use workflows to pre-program analyses for project decision points, and repeat workflows to greatly accelerate re-analysis with updated datasets.</p></li>
<li><p>See impactful oncology example where the commitment to pre-program in NMproject and deliver analysis in stats-like timelines got us onto formal go-nogo: <a href="https://youtu.be/QVw28Im3Zz0" class="uri">https://youtu.be/QVw28Im3Zz0</a>)</p></li>
<li><p>R markdown friendly. Pipe friendly. Create human readable model development logs for other people (or even yourself in 6 months) to read/refresh.</p></li>
</ul>
<p>Prerequisites: NMproject targetted towards mid to upper level R/NONMEM users. If you know what a pipe is, what knitr is, you should be good. If you know dplyr you’ll be able to use the advanced functionality to complex workflows</p>
</div>
<div id="demo" class="section level2">
<h2 class="hasAnchor">
<a href="#demo" class="anchor"></a>Demo</h2>
<p>The easiest way to familiarise your with NMproject is to follow through the demo.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nAkcEFz0RLg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>First create a new NMproject (<code>FILE</code> -&gt; <code>New Project</code> -&gt; <code>New Directory</code> -&gt; <code>New NMproject</code>). You’ll see a clean analysis directory with empty subfolders. Run the following in the new R session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tsahota.github.io/NMproject/">NMproject</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/setup_nm_demo.html">setup_nm_demo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will population the <code>Scripts</code> directory with scripts, and deposit the Theopp dataset into the <code>SourceData</code> subdirectory.</p>
<p>The scripts are numbered s01…..Rmd, s02….Rmd etc., and are designed to be read and run in order. This is the best way to familiarize yourself. The scripts can also be used as template for your own model development</p>
</div>
<div id="nmproject-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#nmproject-usage" class="anchor"></a>NMproject Usage</h2>
<div id="creating-new-r-markdowns" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-new-r-markdowns" class="anchor"></a>Creating new R markdowns</h3>
<p>There is nothing mandating the use of R markdown in NMproject. You can use scripts. However R markdown documents produce nice sharable model development logs which provide a readable description of what steps were performed and in what order.</p>
<p>It is advisable to always start from a template. Templates can be accessed in <code>New Rmarkdown</code> -&gt; <code>From Template</code>. One example template is <code>model generic</code> which can be used to get started with our dataset cleaning and exploratory plotting.</p>
</div>
<div id="data-cleaning" class="section level3">
<h3 class="hasAnchor">
<a href="#data-cleaning" class="anchor"></a>Data cleaning</h3>
<p>Your first script in performing an analysis will probably be a dataset assembly or dataset cleaning. The intent of the <code>SourceData</code> directory is to serve as an entry point of raw or externally produced dataset into your analysis directory.</p>
<p>It is <em>best practice</em> to use relative paths in your code where possible and to avoid using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code> commands to change the working directory. E.g. to read a data set in the <code>SourceData</code> directory, use <code><a href="https://rdrr.io/r/utils/read.table.html">read.csv("SourceData/data.csv")</a></code>.</p>
<p>The <code><a href="../reference/write_derived_data.html">write_derived_data()</a></code> function can be used to save the NONMEM ready dataset into the <code>DerivedData</code> directory:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/write_derived_data.html">write_derived_data</a></span><span class="op">(</span><span class="st">"DerivedData/data.csv"</span><span class="op">)</span></code></pre></div>
<p>See the demo for how/why to create bootstrapped datasets before beginning model development.</p>
</div>
<div id="model-development" class="section level3">
<h3 class="hasAnchor">
<a href="#model-development" class="anchor"></a>Model development</h3>
<p><code>New Rmarkdown</code> -&gt; <code>From Template</code> -&gt; <code>Model development</code> will get you started with a model development log file.</p>
<p>It’s always best to start with NONMEM template too. Search the code library and bring into staging area of analysis project using the <code>code_library</code> addin:</p>
<p>One of the templates is <code>Models/ADVAN2.mod</code>. Select it, <code><a href="../reference/preview.html">preview()</a></code> it and then <code><a href="../reference/stage.html">stage()</a></code> by clicking the buttons and then closing the app.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nTixZB9tfgk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>The model will be in the staging area: <code>staging/Models/ADVAN2.mod</code>, not <code>Models/ADVAN2.mod</code>. Files in the staging area are not to be modified. It’s similar to the <code>SourceData</code> directory in that sense. This is to ensure that we can make changes to <code>ADVAN2.mod</code> in the code library without breaking old analyses that depended on it.</p>
<p>The other important component to understand is that control files are only written to the <code>Models</code> subdirectory just before running nonmem via the <code><a href="../reference/run_nm.html">run_nm()</a></code> command. Prior to this, control file information is stored within the object itself.</p>
<p>Let’s create our first NONMEM object with <code><a href="../reference/new_nm.html">new_nm()</a></code>. This will be a parent run to all other runs and thus requires more set up than other runs. Subsequent child objects will inherits characteristics of the parent.</p>
<p>Three arguments are required to create the parent, a run identifier, <code>run_id</code>, a control file it’s based on, <code>based_on</code>, and a (relative) dataset path <code>data_path</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span>

<span class="va">m1</span></code></pre></div>
<pre><code>## List of 1
##  $ execute.Models/m1
##   ..$ type        : chr "execute"
##   ..$ run_id      : chr "m1"
##   ..$ run_in      : chr "Models"
##   ..$ executed    : logi FALSE
##   ..$ ctl_contents: chr collapsed - view with ctl_contents()
##   ..$ ctl_orig    : chr collapsed - view with ctl_orig()
##   ..$ data_path   : chr "DerivedData/data.csv"
##   ..$ cmd         : chr "execute runm1.mod -dir=m1"
##   ..$ cores       : int 1
##   ..$ run_dir     : chr "m1"
##   ..$ ctl_name    : chr "runm1.mod"
##   ..$ results_dir : chr "Results"
##   ..$ unique_id   : chr "execute.Models/m1"
##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"
##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"
##  - attr(*, "class")= chr [1:2] "nm_list" "list"</code></pre>
<p>Display the object by typing <code>m1</code> in the console. Notice that the <code>run_in</code> field is point to <code>Models</code>. This can be changed by piping the function of the same name e.g. </p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"NONMEM/base_model"</span><span class="op">)</span></code></pre></div>
<p>will run all models in a subdirectory of a subdirectory <code>NONMEM/base_model</code> instead. Any field can by modified using a similar heuristic.</p>
<p>To extract a field (rather than set a field) use the same function without additional arguments:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "NONMEM/base_model"</code></pre>
<p>For now though, lets stay with the default <code>run_in</code> location.</p>
<p><em>NOTE:</em> the field <code>ctl_name</code> refers to the name of the control that will be created. This will only be created when it the model is run with the <code><a href="../reference/run_nm.html">run_nm()</a></code> function (described later). For now, the control file contents reside inside the object. To view these you can use <code><a href="../reference/show_ctl.html">show_ctl(m1)</a></code>, or <code><a href="https://rdrr.io/r/graphics/text.html">text(m1)</a></code>.</p>
<p>A few automatic edits from the staged control file and a compact representation of these changes can be shown by highlighting the above code and selecting the <code>nm_diff</code> addin which show what has been changed.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mYUaKrj0-YE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>Learning how to read to diffs will be an important skill in NMproject you will pick up over time. Notice how the <code>$DATA</code> has been updated to refer to the new location.</p>
<p>The default <code><a href="../reference/nm_getsetters.html">cmd()</a></code> field of the object is <code>execute {ctl_name} -dir={run_dir}</code>. The braces are referred to as <code>glue</code> fields using the <code>glue</code> package. These refer to field names of the object that will be substituted in. For completeness on the next step we will explicitly set this to ensure our model development is easy to read.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span></code></pre></div>
<p>The final steps to gets the NONMEM model ready is to fill in the remaining blanks in the template. They are the <code>$INPUT</code> and <code>$THETA</code>, <code>$OMEGA</code>. For this we will use the <code><a href="../reference/fill_input.html">fill_input()</a></code> and <code><a href="../reference/init_theta.html">init_theta()</a></code> and <code><a href="../reference/init_theta.html">init_omega()</a></code> before piping into our <code><a href="../reference/run_nm.html">run_nm()</a></code> command.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fill_input.html">fill_input</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/init_theta.html">init_sigma</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="fast-nmtran-checks" class="section level3">
<h3 class="hasAnchor">
<a href="#fast-nmtran-checks" class="anchor"></a>Fast NMTRAN checks</h3>
<p>In a cluster environment it is especially important to be able to diagnose data and control file issues before sending jobs off to the grid. Otherwise, you often need to wait minutes for errors that can be spotted immediately. It’s therefore highly recommended to make use of the <code>nm_tran</code> addin. This will only run NMTRAN checks to find control file syntax errors and dataset errors. It will not run nonmem itself. To use this addin, highlight the above code and select the <code>nm_tran</code> addin near the top of the RStudio GUI.</p>
</div>
<div id="manual-edits" class="section level3">
<h3 class="hasAnchor">
<a href="#manual-edits" class="anchor"></a>Manual edits</h3>
<p>Often there will not be the functions to do the control file manipulation you want. Although it is preferable to stick to automatic control file manipulation functions, you can do full tracked <code>manual_edit</code>s via the addin menu. Again, just highlight the code, click the addin and follow the instructions:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HyCHeAAiwy4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>
<div id="shiny-run-monitor" class="section level3">
<h3 class="hasAnchor">
<a href="#shiny-run-monitor" class="anchor"></a>Shiny run monitor</h3>
<p>To view all runs in the workspace and track progress:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shiny_nm.html">shiny_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>To do basic goodness of fit open the post processing Rmarkdown template, follow instructions, customise your template save it (e.g. as <code>Scripts/basic_gof.Rmd</code>) and run in your log script with</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span></code></pre></div>
<p>It will create the output in <code>Results</code> (or results_dir(m1))</p>
<p>If we already have a parent run <code>m1</code> using <code>ADVAN2 TRANS1</code>, we can create a <code><a href="../reference/child.html">child()</a></code> run that uses <code>TRANS2</code> using <code><a href="../reference/subroutine.html">subroutine()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/subroutine.html">subroutine</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>View exactly what’s been changed by highlighting the above code in RStudio and clicking the <code>nm_diff</code> addin to see what’s been changed before running. Here, changes will be in the <code>$SUB</code>, <code>$PK</code> and <code>$THETA</code>.</p>
<p>To add a covariate using PsN coding conventions use <code><a href="../reference/add_cov.html">add_cov()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2WT</span> <span class="op">&lt;-</span> <span class="va">m2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m2WT"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/add_cov.html">add_cov</a></span><span class="op">(</span>param <span class="op">=</span> <span class="st">"CL"</span>, cov <span class="op">=</span> <span class="st">"WT"</span>, state <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Apply a fully editable goodness of fit R markdown template to both runs <code>m2</code> and <code>m3</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span>
<span class="co">## will produce two run specific html reports in the "Results" directory for run evaluation</span></code></pre></div>
<p>Note: <code><a href="https://rdrr.io/r/base/c.html">c(m1, m3)</a></code> is a vector object of 2 NONMEM runs. We’ll touch more on this later.</p>
<p>Evaluate and compare runs on the fly with the following commands</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/rr.html">rr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">m2WT</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##       parameter     type unit trans     Models/m2       Models/m2WT
## 1            KA    THETA  h-1   LOG   1.5 (21.7%)       1.5 (21.6%)
## 2            CL    THETA  h-1   LOG  0.04 (8.33%)    0.0398 (7.83%)
## 3             V    THETA    L   LOG 0.461 (4.65%)     0.459 (4.66%)
## 11 TVCLWTlinear    THETA       &lt;NA&gt;          &lt;NA&gt; -0.0115 (0.00874)
## 4        IIV_KA OMEGAVAR  CV%   LOG  80.6 (21.2%)      80.5 (22.5%)
## 5        IIV_CL OMEGAVAR  CV%   LOG  28.2 (27.9%)      26.1 (34.9%)
## 6         IIV_V OMEGAVAR  CV%   LOG  12.9 (44.6%)        13 (44.5%)
## 7    prop error    SIGMA   SD  &lt;NA&gt; 0.141 (10.3%)     0.134 (12.1%)
## 8     add error    SIGMA   SD  &lt;NA&gt;   0.229 (20%)     0.264 (25.7%)
## 9           OBJ      OBJ       &lt;NA&gt;       104.823           102.719
## 10      CONDNUM  CONDNUM       &lt;NA&gt;      6.63 (0)          7.75 (0)</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_iter.html">plot_iter</a></span><span class="op">(</span><span class="va">m2</span>, skip <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co">## skip first 10 interations </span></code></pre></div>
<p><img src="NMproject_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/covariance_plot.html">covariance_plot</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span></code></pre></div>
<p><img src="NMproject_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<p>However these are better placed inside templates to enable rapid and consistent re-use.</p>
<p>Create a simulation run using <code><a href="../reference/update_parameters.html">update_parameters()</a></code> and <code><a href="../reference/convert_to_simulation.html">convert_to_simulation()</a></code>. Apply vpc and ppc diagnostics</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2s</span> <span class="op">&lt;-</span> <span class="va">m2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m2s"</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="../reference/update_parameters.html">update_parameters</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="../reference/convert_to_simulation.html">convert_to_simulation</a></span><span class="op">(</span>subpr <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">m2s</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_vpc.Rmd"</span><span class="op">)</span>
<span class="va">m2s</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_ppc.Rmd"</span><span class="op">)</span></code></pre></div>
<p>Don’t forget to comment your code with your decision making.</p>
</div>
<div id="clean-up-runs" class="section level3">
<h3 class="hasAnchor">
<a href="#clean-up-runs" class="anchor"></a>Clean up runs</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ls_tempfiles.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span> <span class="co">## will list all temporary files associate with run m1</span>

<span class="co">## remove all temporary files associated with m1</span>
<span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ls_tempfiles.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Not specifying an argument will list temporary files of all runs</span>
<span class="fu"><a href="../reference/ls_tempfiles.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="running-nonmem-in-parallel" class="section level3">
<h3 class="hasAnchor">
<a href="#running-nonmem-in-parallel" class="anchor"></a>Running NONMEM in parallel</h3>
<p>Two fields <code>parafile</code> and <code>cores</code> when combined with a suitable <code>cmd</code> can enable runs to be executed in parallel using PsN.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -parafile={parafile} -dir={run_dir} -nodes={cores}"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm750/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cores</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="bootstraps" class="section level3">
<h3 class="hasAnchor">
<a href="#bootstraps" class="anchor"></a>Bootstraps</h3>
<p>The package <code>rsample</code> can be used to create bootstrap datasets in your initial data manipulation scripts. The following is an example bootstrap dataset being prepared with stratification on <code>SEX</code> and bodyweight <code>WTC</code> categorised in two categories</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>WT_C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">WT</span>, breaks <span class="op">=</span> <span class="fl">2</span>, labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
         STRATA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">SEX</span>, <span class="va">WT_C</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>

<span class="va">d_id</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">%&gt;%</span> <span class="fu">distinct</span><span class="op">(</span><span class="va">ID</span>, <span class="va">STRATA</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>

<span class="co">## create large set of resamples (to enable simulation to grow without ruining seed)</span>
<span class="va">bootsplits</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/bootstraps.html">bootstraps</a></span><span class="op">(</span><span class="va">d_id</span>, <span class="fl">100</span>, strata <span class="op">=</span> <span class="st">"STRATA"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"DerivedData"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">bootsplits</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="st">"DerivedData/bootsplit_data.csv.RData"</span><span class="op">)</span></code></pre></div>
<p>In a model development script, the following, performs a 100 sample bootstrap of model <code>m1</code></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1_boot</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/make_boot_datasets.html">make_boot_datasets</a></span><span class="op">(</span>samples <span class="op">=</span> <span class="fl">100</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">m1_boot</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## the following bootstrap template will wait for results to complete</span>
<span class="va">m1_boot</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_list_render.html">nm_list_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_boot.Rmd"</span><span class="op">)</span></code></pre></div>
<p>Results can be viewed in <code>Results/basic_boot.m1.html</code>.</p>
</div>
<div id="setting-initial-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#setting-initial-estimates" class="anchor"></a>Setting initial estimates</h3>
<p>The functions <code>init_theta</code>, <code>init_omega</code> and <code>init_sigma</code> can be used to get and set initial estimation, parameter bounds, names, units, etc. The work much like the functions used to access fields of the nm object</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## return a tibble version of $OMEGA with init_omega()</span>
<span class="va">io</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">io</span> </code></pre></div>
<pre><code>## $`execute.Models/m1`
##     name omega1 omega2 lower init upper block mblock   FIX unit trans line pos
## 1   &lt;NA&gt;     NA     NA    NA   NA    NA     1     NA FALSE &lt;NA&gt;  &lt;NA&gt;    1   1
## 2 IIV_KA      1      1    NA  0.1    NA     1      1 FALSE &lt;NA&gt;   LOG    2   1
## 3  IIV_K      2      2    NA  0.1    NA     2      1 FALSE &lt;NA&gt;   LOG    3   1
## 4  IIV_V      3      3    NA  0.1    NA     3      1 FALSE &lt;NA&gt;   LOG    4   1
## 5   &lt;NA&gt;     NA     NA    NA   NA    NA    NA     NA FALSE &lt;NA&gt;  &lt;NA&gt;    5   1
##   orig_line orig_pos
## 1         1        1
## 2         2        1
## 3         3        1
## 4         4        1
## 5         5        1</code></pre>
<p>Note that <code>io</code> is a list of a data.frame. This makes manipulation a bit more difficult, but referring to <code>io[[1]]</code> instead <code>io</code> will allows you to manipulate io with R’s standard data.frame manipulation functions. There are also built in functions like <code>block</code> and <code>unblock</code> (to create $OMEGA BLOCKS for correlated random effects).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">io</span> <span class="op">&lt;-</span> <span class="va">io</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/block.html">block</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>  <span class="co">## make block out ETA 2 and 3</span>

<span class="co">## put modified io wit</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="va">io</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"OMEGA"</span><span class="op">)</span></code></pre></div>
<pre><code>## $`execute.Models/m1`
##   1| $OMEGA
##   2| 0.1   ;  IIV_KA ; LOG
##   3| $OMEGA BLOCK (2)
##   4| 0.1   ;  IIV_K ; LOG
##   5| 0.01 0.1   ;  IIV_V ; LOG</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## for demo purposes we'll reverse the process with unblock()</span>
<span class="va">io</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">io</span> <span class="op">&lt;-</span> <span class="va">io</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/unblock.html">unblock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="va">io</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"OMEGA"</span><span class="op">)</span></code></pre></div>
<pre><code>## $`execute.Models/m1`
##   1| $OMEGA
##   2| 0.1   ;   IIV_KA ; LOG
##   3| 0.1   ;   IIV_K ; LOG
##   4| 0.1   ;   IIV_V ; LOG</code></pre>
</div>
<div id="perturbing-initial-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#perturbing-initial-parameters" class="anchor"></a>Perturbing initial parameters</h3>
<p>To modify initial estimates, we’ll use the <code>mutate</code>-like behaviour of <code>init_*</code> functions. We will modify the <code>init</code> by referencing itself. We’ll modified all our fixed effects (log transformed) by 30%</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># m1 &lt;- m1 %&gt;% init_theta(init = rnorm(init, mean = init, sd = 0.3))</span>
<span class="co"># m1 %&gt;% dollar("THETA")  ## view with this</span></code></pre></div>
</div>
</div>
<div id="combining-vectorized-nm-objects-and-dplyr" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-vectorized-nm-objects-and-dplyr" class="anchor"></a>Combining vectorized nm objects and dplyr</h2>
<div id="vectorization" class="section level3">
<h3 class="hasAnchor">
<a href="#vectorization" class="anchor"></a>Vectorization</h3>
<p>The basic nm object is fully vectorized. To see this compare the following two outputs</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span></code></pre></div>
<pre><code>## List of 1
##  $ execute.Models/m1
##   ..$ type        : chr "execute"
##   ..$ run_id      : chr "m1"
##   ..$ run_in      : chr "Models"
##   ..$ executed    : logi TRUE
##   ..$ ctl_contents: chr collapsed - view with ctl_contents()
##   ..$ ctl_orig    : chr collapsed - view with ctl_orig()
##   ..$ data_path   : chr "DerivedData/data.csv"
##   ..$ cmd         : chr "execute runm1.mod -dir=m1"
##   ..$ cores       : int 1
##   ..$ run_dir     : chr "m1"
##   ..$ ctl_name    : chr "runm1.mod"
##   ..$ results_dir : chr "Results"
##   ..$ unique_id   : chr "execute.Models/m1"
##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"
##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"
##  - attr(*, "class")= chr [1:2] "nm_list" "list"</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span></code></pre></div>
<pre><code>## List of 2
##  $ execute.Models/m1
##   ..$ type        : chr "execute"
##   ..$ run_id      : chr "m1"
##   ..$ run_in      : chr "Models"
##   ..$ executed    : logi TRUE
##   ..$ ctl_contents: chr collapsed - view with ctl_contents()
##   ..$ ctl_orig    : chr collapsed - view with ctl_orig()
##   ..$ data_path   : chr "DerivedData/data.csv"
##   ..$ cmd         : chr "execute runm1.mod -dir=m1"
##   ..$ cores       : int 1
##   ..$ run_dir     : chr "m1"
##   ..$ ctl_name    : chr "runm1.mod"
##   ..$ results_dir : chr "Results"
##   ..$ unique_id   : chr "execute.Models/m1"
##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"
##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"
##  $ execute.Models/m2
##   ..$ type              : chr "execute"
##   ..$ run_id            : chr "m2"
##   ..$ run_in            : chr "Models"
##   ..$ parent_run_id     : chr "m1"
##   ..$ parent_run_in     : chr "Models"
##   ..$ parent_ctl_name   : chr "runm1.mod"
##   ..$ parent_results_dir: chr "Results"
##   ..$ executed          : logi TRUE
##   ..$ ctl_contents      : chr collapsed - view with ctl_contents()
##   ..$ ctl_orig          : chr collapsed - view with ctl_orig()
##   ..$ data_path         : chr "DerivedData/data.csv"
##   ..$ cmd               : chr "execute runm2.mod -dir=m2"
##   ..$ cores             : int 1
##   ..$ run_dir           : chr "m2"
##   ..$ ctl_name          : chr "runm2.mod"
##   ..$ results_dir       : chr "Results"
##   ..$ unique_id         : chr "execute.Models/m2"
##   ..$ lst_path          : chr "m2/NM_run1/psn.lst"
##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"
##  - attr(*, "class")= chr [1:2] "nm_list" "list"</code></pre>
<p>Both are nm objects with length 1 and 2, respectively. We used the <code><a href="https://rdrr.io/r/base/c.html">c(m1, m2)</a></code> above when we wanted to use <code><a href="../reference/nm_render.html">nm_render()</a></code> on both runs. We didn’t need to write any loops or special code to handle this because nm objects and the functions that operate on them have been designed with parallelisation in mind. This is because in pharmacometrics we are often dealing with multiple models, perhaps moreso than other statistical modelling disciplines.</p>
<p>The vectorized nature of the nm object is particularly powerful when used in conjuction with <code>dplyr</code>. To demonstrate, lets repeat the the previous initial perturbation exercise, but create 5 runs each with their own perturbed initial estimates.</p>
<p>The basic idea is to contruct a <code>tibble</code> (if you are unfamiliar with <code>tibble</code>s, they are a tidyverse expansion of the concept of a <code>data.frame</code>), and then use a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code> statement to construct a column vector of nm objects. Below the column vector is produced by starting with the parent object <code>m1</code> and then supplying a vector rather than a scalar to the <code><a href="../reference/child.html">child()</a></code> function. Since the <code>rep</code> column is length 5, this will make the nm_object length 5.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dp</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>rep <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    m <span class="op">=</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="co">## start with single parent run, m1, an nm object of length 1</span>
      <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">rep</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## rep is vector of length 5</span>
      <span class="co">## this makes the child() output a nm object vector of length 5 - each</span>
      <span class="co">## with a unique run_id do the same manipulation above - since NMproject</span>
      <span class="co">## functions are vectorized, this will apply the same manipulation</span>
      <span class="co">## elementwise</span>
      <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">init</span>, mean <span class="op">=</span> <span class="va">init</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dp</span><span class="op">$</span><span class="va">m</span><span class="op">)</span>

<span class="co">## the m column of dp is a nm object vector, display all $THETAs like this</span>
<span class="va">dp</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span>

<span class="co">## run all runs in dp$m with the normal syntax </span>
<span class="va">dp</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Here the functions <code>init_theta</code>, <code>dollar</code> and <code>run_nm</code> were all operating in a vectorized fashion</p>
</div>
<div id="automating-model-checking" class="section level3">
<h3 class="hasAnchor">
<a href="#automating-model-checking" class="anchor"></a>Automating model checking</h3>
<p>Lets expand the earlier subroutine example to build a vector of runs that test multiple different <code>ADVAN</code>s and <code>TRANS</code> at the same time.</p>
<p>We’ll use a similar structure to the previous section using <code>.available_advans</code> to list all available advans, <code>filter</code> to isolate specific advans, and <code>mutate</code> and <code><a href="../reference/subroutine.html">subroutine()</a></code> to perform the control file manipulation function.</p>
<p>Then we’ll display all the <code>$PK</code> subroutines to view the changes.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.available_advans</span> <span class="co">## display available advans</span></code></pre></div>
<pre><code>## # A tibble: 20 x 6
##    advan trans   cmt oral  params                  label
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;chr&gt;                   &lt;chr&gt;
##  1     1     1     1 FALSE K,V                     a1t1 
##  2     1     2     1 FALSE CL,V                    a1t2 
##  3     2     1     1 TRUE  KA,K,V                  a2t1 
##  4     2     2     1 TRUE  KA,CL,V                 a2t2 
##  5     3     1     2 FALSE K,K12,K21,V             a3t1 
##  6     3     3     2 FALSE CL,Q,V,VSS              a3t3 
##  7     3     4     2 FALSE CL,Q,V1,V2              a3t4 
##  8     4     1     2 TRUE  KA,K,K23,K32,V2         a4t1 
##  9     4     3     2 TRUE  KA,CL,Q,V,VSS           a4t3 
## 10     4     4     2 TRUE  KA,CL,Q,V2,V3           a4t4 
## 11     5     1    NA NA    KXY,VX                  a5t1 
## 12     6     1    NA NA    KXY,VX                  a6t1 
## 13     7     1    NA NA    KXY,VX                  a7t1 
## 14     8     1    NA NA    KXY,VX                  a8t1 
## 15     9     1    NA NA    KXY,VX                  a9t1 
## 16    11     1     3 FALSE K,K12,K21,K13,K31,V     a11t1
## 17    11     4     3 FALSE CL,Q2,V1,V2,Q3,V3       a11t4
## 18    12     1     3 TRUE  KA,K,K23,K32,K24,K42,V2 a12t1
## 19    12     4     3 TRUE  KA,CL,Q3,V2,V3,Q4,V4    a12t4
## 20    13     1    NA NA    KXY,VX                  a13t1</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">.available_advans</span> <span class="op">%&gt;%</span>
  <span class="co">## filter only for oral dosing advans</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">oral</span> <span class="op">%in%</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">## mutate state create a column vector m of nm objects</span>
  <span class="co">## first step is to create children runs from the parent object m1</span>
  <span class="co">## this is done by supplying a vector of run_ids to the child() function</span>
  <span class="fu">mutate</span><span class="op">(</span>m <span class="op">=</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="co">## start with parent m1 again</span>
           <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">label</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## create multiple children using "label" column</span>
           <span class="co">## then use advan and trans columns with subroutine()</span>
           <span class="fu"><a href="../reference/subroutine.html">subroutine</a></span><span class="op">(</span>advan <span class="op">=</span> <span class="va">advan</span>, trans <span class="op">=</span> <span class="va">trans</span><span class="op">)</span><span class="op">)</span>

<span class="co">## view the $PK blocks of each</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"PK"</span><span class="op">)</span></code></pre></div>
<pre><code>## $`execute.Models/a2t1`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVK=EXP(THETA(2))
##   8| MU_2=LOG(TVK)
##   9| K = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV=EXP(THETA(3))
##  12| MU_3=LOG(TVV)
##  13| V = EXP(MU_3+ETA(3))
##  14| 
##  15| CL = K*V
##  16| 
##  17| S2 = V
##  18| 
## 
## $`execute.Models/a2t2`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVCL=EXP(THETA(2))
##   8| MU_2=LOG(TVCL)
##   9| CL = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV=EXP(THETA(3))
##  12| MU_3=LOG(TVV)
##  13| V = EXP(MU_3+ETA(3))
##  14| 
##  15| ; CL = K*V
##  16| 
##  17| S2 = V
##  18| 
## 
## $`execute.Models/a4t1`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVK=EXP(THETA(2))
##   8| MU_2=LOG(TVK)
##   9| K = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV2=EXP(THETA(3))
##  12| MU_3=LOG(TVV2)
##  13| V2 = EXP(MU_3+ETA(3))
##  14| 
##  15| CL = K*V2
##  16| 
##  17| S2 = V2
##  18| 
##  19| TVK23=EXP(THETA(4))
##  20| MU_4=LOG(TVK23)
##  21| K23 = EXP(MU_4+ETA(4))
##  22| TVK32=EXP(THETA(5))
##  23| MU_5=LOG(TVK32)
##  24| K32 = EXP(MU_5+ETA(5))
## 
## $`execute.Models/a4t3`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVCL=EXP(THETA(2))
##   8| MU_2=LOG(TVCL)
##   9| CL = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV=EXP(THETA(3))
##  12| MU_3=LOG(TVV)
##  13| V = EXP(MU_3+ETA(3))
##  14| 
##  15| ; CL = K*V
##  16| 
##  17| S2 = V
##  18| 
##  19| TVQ=EXP(THETA(4))
##  20| MU_4=LOG(TVQ)
##  21| Q = EXP(MU_4+ETA(4))
##  22| TVVSS=EXP(THETA(5))
##  23| MU_5=LOG(TVVSS)
##  24| VSS = EXP(MU_5+ETA(5))
## 
## $`execute.Models/a4t4`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVCL=EXP(THETA(2))
##   8| MU_2=LOG(TVCL)
##   9| CL = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV2=EXP(THETA(3))
##  12| MU_3=LOG(TVV2)
##  13| V2 = EXP(MU_3+ETA(3))
##  14| 
##  15| ; CL = K*V
##  16| 
##  17| S2 = V2
##  18| 
##  19| TVQ=EXP(THETA(4))
##  20| MU_4=LOG(TVQ)
##  21| Q = EXP(MU_4+ETA(4))
##  22| TVV3=EXP(THETA(5))
##  23| MU_5=LOG(TVV3)
##  24| V3 = EXP(MU_5+ETA(5))
## 
## $`execute.Models/a12t1`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVK=EXP(THETA(2))
##   8| MU_2=LOG(TVK)
##   9| K = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV2=EXP(THETA(3))
##  12| MU_3=LOG(TVV2)
##  13| V2 = EXP(MU_3+ETA(3))
##  14| 
##  15| CL = K*V2
##  16| 
##  17| S2 = V2
##  18| 
##  19| TVK23=EXP(THETA(4))
##  20| MU_4=LOG(TVK23)
##  21| K23 = EXP(MU_4+ETA(4))
##  22| TVK32=EXP(THETA(5))
##  23| MU_5=LOG(TVK32)
##  24| K32 = EXP(MU_5+ETA(5))
##  25| TVK24=EXP(THETA(6))
##  26| MU_6=LOG(TVK24)
##  27| K24 = EXP(MU_6+ETA(6))
##  28| TVK42=EXP(THETA(7))
##  29| MU_7=LOG(TVK42)
##  30| K42 = EXP(MU_7+ETA(7))
## 
## $`execute.Models/a12t4`
##   1| $PK
##   2| 
##   3| TVKA=EXP(THETA(1))
##   4| MU_1=LOG(TVKA)
##   5| KA = EXP(MU_1+ETA(1))
##   6| 
##   7| TVCL=EXP(THETA(2))
##   8| MU_2=LOG(TVCL)
##   9| CL = EXP(MU_2+ETA(2))
##  10| 
##  11| TVV2=EXP(THETA(3))
##  12| MU_3=LOG(TVV2)
##  13| V2 = EXP(MU_3+ETA(3))
##  14| 
##  15| ; CL = K*V
##  16| 
##  17| S2 = V2
##  18| 
##  19| TVQ3=EXP(THETA(4))
##  20| MU_4=LOG(TVQ3)
##  21| Q3 = EXP(MU_4+ETA(4))
##  22| TVV3=EXP(THETA(5))
##  23| MU_5=LOG(TVV3)
##  24| V3 = EXP(MU_5+ETA(5))
##  25| TVQ4=EXP(THETA(6))
##  26| MU_6=LOG(TVQ4)
##  27| Q4 = EXP(MU_6+ETA(6))
##  28| TVV4=EXP(THETA(7))
##  29| MU_7=LOG(TVV4)
##  30| V4 = EXP(MU_7+ETA(7))</code></pre>
<p>Let’s run these, summarise the results, and generate goodness of fit diagnostics for the ones that gave somewhat reasonable outputs</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run them all and wait for them to finish</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## summarise all runs in a table</span>
<span class="fu"><a href="../reference/summary_wide.html">summary_wide</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">m</span><span class="op">)</span>

<span class="co">## plot goodness of fits for all runs with ofv &lt; 120</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="fu"><a href="../reference/ofv.html">ofv</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">120</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## subsetting is a powerful way of isolating functions to particular model objects</span>
  <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span></code></pre></div>
</div>
<div id="parallel-efficiency-test" class="section level3">
<h3 class="hasAnchor">
<a href="#parallel-efficiency-test" class="anchor"></a>Parallel efficiency test</h3>
<p>Often you’ll want to know the right level of parallelisation to run your model to maximise speed without wasting too many resources. The following creates multiple runes with different levels of parallelisation. We’ll just test it across 1, 3, 10, and 30 cores, but this can be any vector.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dc</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>m <span class="op">=</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="co">## start with parent m1 again</span>
           <span class="co">## supply the "cores" vector (of the tibble) to child(), this will create 3 runs</span>
           <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">cores</span><span class="op">)</span> <span class="op">%&gt;%</span>
           <span class="co">## run them all in m1_coretest</span>
           <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_coretest"</span><span class="op">)</span> <span class="op">%&gt;%</span>
           <span class="co">## run them all with the following execute command</span>
           <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -parafile={parafile} -dir={run_dir} -nodes={cores}"</span><span class="op">)</span> <span class="op">%&gt;%</span>
           <span class="co">## and the following parafile</span>
           <span class="fu"><a href="../reference/nm_getsetters.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm75/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
           <span class="co">## and finally set the cores to the "cores" vector</span>
           <span class="fu"><a href="../reference/nm_getsetters.html">cores</a></span><span class="op">(</span><span class="va">cores</span><span class="op">)</span><span class="op">)</span>

<span class="va">dc</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "execute run1.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=1 -nodes=1"   
## [2] "execute run3.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=3 -nodes=3"   
## [3] "execute run10.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=10 -nodes=10"
## [4] "execute run30.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=30 -nodes=30"</code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run them all and wait for them to finish</span>
<span class="va">dc</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## extract job statistics and plot cores vs Rtime or Ttime to get plots of run</span>
<span class="co">## time and total time vs number of CPUs</span>

<span class="va">dc</span><span class="op">$</span><span class="va">m</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/job_stats.html">job_stats</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">cores</span>, y <span class="op">=</span> <span class="va">Rtime</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="simulation-re-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#simulation-re-estimation" class="anchor"></a>Simulation re-estimation</h3>
<p>You can also use the vectorized nature to create a simulation re-estimation routines from scratch.</p>
<p>Whenever making a routine that will scale up to 100s or 1000s or runs, always start with 1 or 2 replicates. Get the code working below, and then rerun with desired number of replicates (here we’re just using 3 for demo purposes). You will not waste time because <code><a href="../reference/run_nm.html">run_nm()</a></code> will skip over runs that have already completed.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co">## start small, scale up later</span>

<span class="va">dsr</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>sim <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    msim <span class="op">=</span> <span class="va">m1</span> <span class="op">%&gt;%</span>              <span class="co">## start with single parent run, m1, an nm object of length 1</span>
      <span class="fu"><a href="../reference/update_parameters.html">update_parameters</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## update inits to finals, here nm object is still length 1</span>
      <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">sim</span>, parent <span class="op">=</span> <span class="va">m1</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## at this point it becomes length n_sims</span>
      <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_simest"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## this applies the run_in modification to all n_sims runs</span>
      <span class="fu"><a href="../reference/convert_to_simulation.html">convert_to_simulation</a></span><span class="op">(</span>subpr <span class="op">=</span> <span class="fl">1</span>, seed <span class="op">=</span> <span class="va">sim</span><span class="op">)</span> <span class="co">## converts all to simulation</span>
  <span class="op">)</span>

<span class="co">## run, wait, read results and then write to run_dir paths of simulations</span>
<span class="va">dsr</span><span class="op">$</span><span class="va">msim</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/output_table.html">output_table</a></span><span class="op">(</span>only_append <span class="op">=</span> <span class="st">"DV_OUT"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/write_derived_data.html">write_derived_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/run_dir_path.html">run_dir_path</a></span><span class="op">(</span><span class="va">dsr</span><span class="op">$</span><span class="va">msim</span><span class="op">)</span>, <span class="st">"simdata.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Now create mest column</span>
<span class="va">dsr</span> <span class="op">&lt;-</span> <span class="va">dsr</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    mest <span class="op">=</span> <span class="va">m1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">sim</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## estimations derived from m1</span>
      <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_simest/est"</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co">## run in a new subdirectory</span>
      <span class="fu"><a href="../reference/data_path.html">data_path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/run_dir_path.html">run_dir_path</a></span><span class="op">(</span><span class="va">msim</span><span class="op">)</span>, <span class="st">"simdata.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co">## set new data_paths</span>
      <span class="co">## refill $INPUT. Rename DV to be DV_OUT column. Run nm_diff() command below to see</span>
      <span class="co">## what has changed</span>
      <span class="fu"><a href="../reference/fill_input.html">fill_input</a></span><span class="op">(</span>rename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"DV_OBS"</span> <span class="op">=</span> <span class="st">"DV"</span>, <span class="st">"DV"</span> <span class="op">=</span> <span class="st">"DV_OUT"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># nm_diff(dsr$mest[1])</span>

<span class="va">dsr</span><span class="op">$</span><span class="va">mest</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/summary_wide.html">summary_wide</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="faq" class="section level2">
<h2 class="hasAnchor">
<a href="#faq" class="anchor"></a>FAQ</h2>
<div id="after-having-closed-my-session-how-to-i-recreate-my-workspace" class="section level3">
<h3 class="hasAnchor">
<a href="#after-having-closed-my-session-how-to-i-recreate-my-workspace" class="anchor"></a>+ After having closed my session how to I recreate my workspace</h3>
<p>Just re-run all the code again.</p>
<p>If nothing has changed with regards to datasets and control files run_nm() will retrieve cached results without running nonmem.</p>
</div>
<div id="i-see-the-pmx-code-library-has-been-updated-how-can-i-update-my-local-version-of-it" class="section level3">
<h3 class="hasAnchor">
<a href="#i-see-the-pmx-code-library-has-been-updated-how-can-i-update-my-local-version-of-it" class="anchor"></a>+ I see the PMX code library has been updated, how can I update my local version of it?</h3>
<p>The PMX code library is version controlled with <code>git</code>. Ensure you have git installed, navigate to the local PMX code library repository and type <code>git pull</code>. Git will complain if you have made changes to your local directory since downloading it. If you have, you need to <code>commit</code> those changes before using <code>git pull</code>. See git help for more information on how to do this. Consider splitting your code library into multiple repositories for easier management (e.g. one public, one for your organisation, one for you)</p>
</div>
<div id="we-already-have-directory-of-rnonmem-scriptstemplates-how-can-we-also-use-these" class="section level3">
<h3 class="hasAnchor">
<a href="#we-already-have-directory-of-rnonmem-scriptstemplates-how-can-we-also-use-these" class="anchor"></a>+ We already have directory of R/NONMEM scripts/templates, how can we also use these?</h3>
<p>Append your directory location to the <code>code_library_path</code> option. To do this add the following command to your <code>~/.Rprofile</code> (or <code>$R_HOME/etc/Rprofile.site</code>) configuration file:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>code_library_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"/path/to/PMXcodelibrary/"</span>,
                              <span class="st">"path/to/existing/repository"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="how-can-i-contribute-to-the-pmx-code-library" class="section level3">
<h3 class="hasAnchor">
<a href="#how-can-i-contribute-to-the-pmx-code-library" class="anchor"></a>+ How can I contribute to the PMX code library?</h3>
<p>Log in to github (create an account if necessary). Fork the repository <code>tsahota/PMXcodelibrary</code>. Make your change. Create a pull request detailing your change.</p>
</div>
<div id="how-do-i-run-this-on-sge" class="section level3">
<h3 class="hasAnchor">
<a href="#how-do-i-run-this-on-sge" class="anchor"></a>+ How do I run this on SGE?</h3>
<p>There is a pre-prepared built in <code>sge_parallel_execute</code> character object that’s part of NMproject. This uses the grid functionality built into PsN and has been tested to work within the Metworx platform. Simply type it in the console to see the contents. Required fields are <code>parafile</code>, <code>cores</code>. Ensure these are set for your parent object like so.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="va">sge_parallel_execute</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm75/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cores</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Note that child object will inherit the same <code>cmd</code> structure, <code>cores</code> and <code>parafile</code>.</p>
</div>
<div id="how-do-i-run-this-on-other-clusters-like-slurm-lsf-torque" class="section level3">
<h3 class="hasAnchor">
<a href="#how-do-i-run-this-on-other-clusters-like-slurm-lsf-torque" class="anchor"></a>+ How do I run this on other clusters like Slurm, LSF, Torque</h3>
<p>The workflow is similar to above where PsN handles the grid submission. You will need to create your own analog character to <code>sge_parallel_execute</code> for your respective cluster. It is recommended to consult PsN documentation to “gridify” your PsN command. Once you have this, it’s just a simple matter of replacing your control file name, run directory, parafile and desired number of cores with the relevant glue field (e.g. <code>{parafile}</code>) and then putting it into your parent <code><a href="../reference/nm_getsetters.html">cmd()</a></code> command to get it running through NMproject.</p>
<p>Feel free to contact me if you need help</p>
</div>
<div id="how-do-i-run-nonmem-via-a-psnnonmem-docker-container" class="section level3">
<h3 class="hasAnchor">
<a href="#how-do-i-run-nonmem-via-a-psnnonmem-docker-container" class="anchor"></a>+ How do I run NONMEM via a PsN/NONMEM docker container</h3>
<p>This requires setting <code><a href="../reference/nm_getsetters.html">cmd()</a></code> field of the first (parent) nm object and also setting <code><a href="../reference/nm_tran_command.html">nm_tran_command()</a></code> once in your script.</p>
<p>Easiest way to understand this is via an example: The following assumes the docker container has been set as shown in the fabulous <code>https://github.com/billdenney/Pharmacometrics-Docker</code> repository:</p>
<p>Set cmd for an <code>execute</code> command like so:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/run_nm.html">run_nm()</a></code> will then execute NONMEM via the docker container. All subsequent child objects will inherit the same command structure. Note the use the glueing object fields <code>ctl_name</code> and <code>run_dir</code> so child objects can inherit the same command structure to save the command being rewritten for each run)</p>
<p>Set up dockerized NMTRAN checking with:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nm_tran_command.html">nm_tran_command</a></span><span class="op">(</span><span class="st">"docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn /bin/bash -c '/opt/NONMEM/nm_current/tr/NMTRAN.exe &lt; {ctl_name}'"</span><span class="op">)</span></code></pre></div>
</div>
<div id="my-rstudio-server-is-on-a-different-linux-server-to-my-nonmem-cluster--how-can-i-set-up-nmproject-to-work-with-this" class="section level3">
<h3 class="hasAnchor">
<a href="#my-rstudio-server-is-on-a-different-linux-server-to-my-nonmem-cluster--how-can-i-set-up-nmproject-to-work-with-this" class="anchor"></a>+ My Rstudio Server is on a different linux server to my NONMEM cluster. How can I set up NMproject to work with this?</h3>
<p>You need to ensure your account has passwordless ssh set up. Then create a <code><a href="../reference/system_nm.html">system_nm()</a></code> option in your <code>~/.Rprofile</code> configuration file which appends an ssh statement to the system call e.g. the following will set you up to connect to the host <code>clustername</code>:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>system_nm<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">cmd</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"ssh -q clustername \"cd $(pwd); "</span>,<span class="va">cmd</span>,<span class="st">"\""</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="im-working-on-a-windows-laptop-but-want-to-use-my-nonmem-cluster-for-nonmem-jobs--how-can-i-set-up-nmproject-to-work-with-this" class="section level3">
<h3 class="hasAnchor">
<a href="#im-working-on-a-windows-laptop-but-want-to-use-my-nonmem-cluster-for-nonmem-jobs--how-can-i-set-up-nmproject-to-work-with-this" class="anchor"></a>+ I’m working on a windows laptop but want to use my NONMEM cluster for NONMEM jobs. How can I set up NMproject to work with this?</h3>
<p>This is not recommended as it requires R working directory being set to a networked drive. This is very slow. If you really want to though consider modifying the <code><a href="../reference/system_nm.html">system_nm()</a></code> option, as in the above FAQ question, to use <code>plink</code> to ssh to the server, change to the relevant working directory and submit a command. This has not been tested however and results are likely to be disappointing.</p>
</div>
<div id="my-organisation-has-a-different-control-file-convention-to-the-runxx-mod-convention--can-i-change-this" class="section level3">
<h3 class="hasAnchor">
<a href="#my-organisation-has-a-different-control-file-convention-to-the-runxx-mod-convention--can-i-change-this" class="anchor"></a>+ My organisation has a different control file convention to the runXX.mod convention. Can I change this?</h3>
<p>Yes, you can specify the convention with the ctl_path() on your parent object e.g. to change the convention to nm.XX.con</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ctl_path.html">ctl_path</a></span><span class="op">(</span><span class="st">"Models/nm.{run_id}.com"</span><span class="op">)</span></code></pre></div>
</div>
<div id="how-do-i-submit-a-command-directly-to-the-nonmem-server" class="section level3">
<h3 class="hasAnchor">
<a href="#how-do-i-submit-a-command-directly-to-the-nonmem-server" class="anchor"></a>+ How do I submit a command directly to the NONMEM server?</h3>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/system_nm.html">system_nm</a></span><span class="op">(</span><span class="st">"command_to_run"</span>, dir<span class="op">=</span><span class="st">"path/to/dir"</span><span class="op">)</span></code></pre></div>
</div>
<div id="there-is-functionality-in-psns-runrecord-sumo-or-pirana-that-i-would-like-but-is-not-currently-available-in-nmproject-" class="section level3">
<h3 class="hasAnchor">
<a href="#there-is-functionality-in-psns-runrecord-sumo-or-pirana-that-i-would-like-but-is-not-currently-available-in-nmproject-" class="anchor"></a>+ There is functionality in PsN’s runrecord, sumo or Pirana that I would like but is not currently available in NMproject.</h3>
<p>NMproject doesn’t change PsN’s default directory structure, everything in the “Models” directory is as if you lauched the jobs from the command line. Therefore you can continue to use PsN functions on the command line. You can also continue using Pirana by pointing it towards your models directory.</p>
<p>If it’s something you think really should be part of NMproject, open a github “issue” and ask for the feature.</p>
</div>
<div id="i-dont-want-to-use-nmproject-on-my-analysis-project-any-more-can-i-go-back-to-submitting-runs-on-the-command-line" class="section level3">
<h3 class="hasAnchor">
<a href="#i-dont-want-to-use-nmproject-on-my-analysis-project-any-more-can-i-go-back-to-submitting-runs-on-the-command-line" class="anchor"></a>+ I don’t want to use NMproject on my analysis project any more, can I go back to submitting runs on the command line</h3>
<p>Yes, NMproject doesn’t change PsN’s default directory structure, so you can go back to running PsN via command line. If there a bug or a feature you think really should be part of NMproject, consider opening a github “issue” and asking.</p>
</div>
<div id="i-work-for-a-cro--my-client-doesnt-have-nmproject-how-can-send-the-analysis-to-them-" class="section level3">
<h3 class="hasAnchor">
<a href="#i-work-for-a-cro--my-client-doesnt-have-nmproject-how-can-send-the-analysis-to-them-" class="anchor"></a>+ I work for a CRO. My client doesn’t have NMproject, how can send the analysis to them.</h3>
<p>NMproject doesn’t change PsN’s default directory structure, and everything will work for them as long as their version of R (and package versions) are compatible. It is recommended to run Renvironment_info() as a last step before sending the analysis directory so they can see the package versions you used.</p>
<p>Obviously they will not be able to run code that is dependent on NMproject unless they install it. But your model development script can still serve as a helpful, human readable process description of your model development steps.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tarj Sahota.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

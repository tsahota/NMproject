<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NMproject • NMproject</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="NMproject">
<meta property="og:description" content="NMproject">
<meta property="og:image" content="https://tsahota.github.io/NMproject/logo.svg">
<meta name="google-site-verification" content="Asq9eKyn87Krpkza8Y-Y_XiS5V6eNXGAreGhOYcBKd0">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NMproject</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.7.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/NMproject.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a01_config.html">Configuration &amp; Setup Options</a>
    </li>
    <li>
      <a href="../articles/a02_analysis_directories.html">Analysis Directories</a>
    </li>
    <li>
      <a href="../articles/a03_demo.html">The Demo</a>
    </li>
    <li>
      <a href="../articles/a04_code_library.html">Code Library</a>
    </li>
    <li>
      <a href="../articles/a05_core_object.html">The basics of the NM object</a>
    </li>
    <li>
      <a href="../articles/a06_execution.html">NONMEM execution</a>
    </li>
    <li>
      <a href="../articles/a07_post_processing.html">Post-processing &amp; diagnostics</a>
    </li>
    <li>
      <a href="../articles/a08_covariate_modelling.html">Covariate Modelling</a>
    </li>
    <li>
      <a href="../articles/a09_advanced_topics.html">Advanced Topics</a>
    </li>
    <li>
      <a href="../articles/a10_FAQ.html">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tsahota/NMproject/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="NMproject_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>NMproject</h1>
                        <h4 data-toc-skip class="author">Tarj Sahota</h4>
            
            <h4 data-toc-skip class="date">2022-02-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tsahota/NMproject/blob/HEAD/vignettes/articles/NMproject.Rmd" class="external-link"><code>vignettes/articles/NMproject.Rmd</code></a></small>
      <div class="hidden name"><code>NMproject.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="why-nmproject">Why NMproject?<a class="anchor" aria-label="anchor" href="#why-nmproject"></a>
</h2>
<div class="section level3">
<h3 id="history">History<a class="anchor" aria-label="anchor" href="#history"></a>
</h3>
<p>NMproject’s initial outing (the “alpha” interface) was developed in AZ and internally had 83% voluntary user retention (“user” = someone with 5+ separate model development workflows) across 100s of analyses in all TAs. It was a prototype R package produced to demonstrate the concept of industrialising pharmacometric analyses via script based model development. Key benefits included:</p>
<ol style="list-style-type: decimal">
<li><p>script-based model development workflows being used as the primary location to record modeller thoughts/notes/decisions alongside reproducible, re-executable code</p></li>
<li><p>a code library to encourage standardisation and sharing of best coding practices</p></li>
<li><p>compatibility with PsN and Pirana</p></li>
<li><p>installable in a wide variety of infrastructures in multiple organisations, from standalone windows installations to large unix based clusters</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="new-interface">New interface<a class="anchor" aria-label="anchor" href="#new-interface"></a>
</h3>
<p>This is the new “beta” interface. A completely redesigned syntax that address several shortcoming of the previous syntax and expands functionality. Why the redesign?</p>
<ul>
<li><p>(<em>New</em>)End-to-end model development workflows/notebooks for people who want 100% control over their model files. The new interface is the only NONMEM interface (known to the author) that can record and replay manual edits to files (seemlessly) for 100% flexibility without breaking the end-to-end reproducibility.</p></li>
<li><p>(<em>New</em>)R Functions to automatically fill $INPUT, $DATA, $THETA,… elements as well as various other routine model file manipulations</p></li>
<li><p>(<em>New</em>)Import code library templates (via a shiny interface) and get to a working NONMEM model quickly and entirely within R. See demo.</p></li>
<li><p>(<em>New</em>)NMproject is the only R package (known to the author) with a vectorised model object allowing groups of models to be operated on using the same syntax as a single model.</p></li>
<li><p>(<em>New</em>)Custom NMproject implementations of bootstrap, cross-validation, PPCs, stepwise covariate selection, and simulation-re-estimation. All controllable on granular level using vectorised model objects.</p></li>
<li><p>Diagnostics and VPCs using your favourite packages (e.g., ‘xpose’, ‘vpc’, …)</p></li>
<li><p>(<em>New</em>)RStudio ‘Addins’ to streamline user experience.</p></li>
<li><p>Monitor runs via shiny app including interactive OFV vs iteration plots for convergence assessment.</p></li>
<li><p>Optional customisable analysis directory structure for consistent code organisation</p></li>
<li><p>(<em>New</em>)R markdown friendly. Pipe friendly</p></li>
</ul>
<p>NMproject has been used to conduct exploratory analyses and submission work. Model based power calculations were performed with NMproject in collaboration with biostatistics to demonstrate feasibility, design (sample size and dose), and to plan interim decision points of a recently published oncology dose finding study using pharmacometric endpoints: <a href="https://youtu.be/QVw28Im3Zz0" class="external-link">video presentation</a></p>
</div>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>NMproject targetted towards mid to upper level R users. If you know what a pipe is, what Knitr is, you should be good. NMproject does not hide NONMEM from the user so users should be familiar with NONMEM coding. For advanced functionality, knowledge of <code>dplyr</code> will help to create complex workflows.</p>
</div>
</div>
<div class="section level2">
<h2 id="demo">Demo<a class="anchor" aria-label="anchor" href="#demo"></a>
</h2>
<p>The easiest way to familiarise your with NMproject is to run through the demo scripts line by line. Here’s a short YouTube video on running the demo</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nAkcEFz0RLg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>Run the following in the new R session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tsahota.github.io/NMproject/">NMproject</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/setup_nm_demo.html">setup_nm_demo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will population the <code>Scripts</code> directory with scripts, and deposit the Theopp dataset into the <code>SourceData</code> subdirectory.</p>
<p>The scripts are numbered <code>s01.....Rmd</code>, <code>s02....Rmd</code> etc., and are designed to be read and run in order. The scripts can also be used as template for your own model development</p>
</div>
<div class="section level2">
<h2 id="code-and-data-preparation">Code and data preparation<a class="anchor" aria-label="anchor" href="#code-and-data-preparation"></a>
</h2>
<div class="section level3">
<h3 id="creating-analysis-project">Creating Analysis Project<a class="anchor" aria-label="anchor" href="#creating-analysis-project"></a>
</h3>
<p>It is recommended to work in structured. Create a new analysis project via the RStudio menu items: <code>FILE</code> -&gt; <code>New Project</code> -&gt; <code>New Directory</code> -&gt; <code>New NMproject</code>. The underlying function being used to create this analysis project is <code><a href="../reference/nm_create_analysis_project.html">nm_create_analysis_project()</a></code>. See documentation for detailed information including how to modify the structure to suit your preferences.</p>
<p>Follow through the instructions, you’ll be asked for a location, a name and whether you want to use <code>renv</code> to manage project library directories. See <code>renv</code> documentation for more information.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nAkcEFz0RLg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>Once created you’ll see a clean analysis directory with empty subfolders.</p>
<p>Default the subdirectories for model development (these can be modified - see <code><a href="../reference/nm_create_analysis_project.html">nm_create_analysis_project()</a></code> documentation):</p>
<ul>
<li><p>SourceData : intended for unmodified source datasets entering the analysis project</p></li>
<li><p>DerivedData : intended for cleaned and processed NONMEM ready datasets</p></li>
<li><p>Scripts : intended for all R scripts</p></li>
<li><p>Models : intended for all NONMEM modelling</p></li>
<li><p>Results : intended as default location for run diagnostics, plots and tables</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="creating-new-r-markdowns">Creating new R markdowns<a class="anchor" aria-label="anchor" href="#creating-new-r-markdowns"></a>
</h3>
<p>There is nothing mandating the use of R markdown in NMproject. You can use scripts. However R markdown documents produce nice shareable model development logs which provide a readable description of what steps were performed and in what order.</p>
<p>It is advisable to always start from a template. Templates can be accessed in <code>File</code> -&gt; <code>New File</code> -&gt; <code>R markdown...</code> -&gt; <code>From Template</code>. Two to get started with are <code>NMproject generic</code> which we’ll use as a generic template for data processing and cleaning and <code>model development</code> for our model development notebook.</p>
</div>
<div class="section level3">
<h3 id="data-cleaning">Data cleaning<a class="anchor" aria-label="anchor" href="#data-cleaning"></a>
</h3>
<p>Your first script in performing an analysis will probably be a dataset assembly or dataset cleaning. It’s easiest to start with the generic <code>NMproject generic</code> R markdown template.</p>
<p>The intent of the <code>SourceData</code> directory is to serve as an entry point of raw or externally produced dataset into your analysis directory.</p>
<p>It is <em>best practice</em> to use relative paths in your code where possible and to avoid using <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd()</a></code> commands to change the working directory. E.g. to read a data set in the <code>SourceData</code> directory, use <code>read.csv("SourceData/data.csv")</code>.</p>
<p>The <code><a href="../reference/write_derived_data.html">write_derived_data()</a></code> function can be used to save the NONMEM ready dataset into the <code>DerivedData</code> directory:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/write_derived_data.html">write_derived_data</a></span><span class="op">(</span><span class="st">"DerivedData/data.csv"</span><span class="op">)</span></code></pre></div>
<p>See the demo for how/why to create bootstrapped datasets before beginning model development.</p>
</div>
<div class="section level3">
<h3 id="code-library">Code Library<a class="anchor" aria-label="anchor" href="#code-library"></a>
</h3>
<p>It’s always best to start with NONMEM template too. Search the code library and bring into staging area of analysis project using the “code_library” RStudio ‘Addin’:</p>
<p>One of the templates is <code>Models/ADVAN2.mod</code>. Select it, <code>preview</code> it and then <code>import</code> by clicking the buttons and then closing the app.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nTixZB9tfgk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>The model will be in the staging area: <code>staging/Models/ADVAN2.mod</code>, not <code>Models/ADVAN2.mod</code>. Files in the staging area are not to be modified. It’s similar to the <code>SourceData</code> directory in that sense. This is to ensure that we can make changes to <code>ADVAN2.mod</code> in the code library without breaking old analyses that depended on it.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-development">Model development<a class="anchor" aria-label="anchor" href="#model-development"></a>
</h2>
<p><code>File</code> -&gt; <code>New File</code> -&gt; <code>New R markdown...</code> -&gt; <code>From Template</code> -&gt; <code>Model development</code> will get you started with a model development log file.</p>
<div class="section level3">
<h3 id="the-core-nm-object">The core nm object<a class="anchor" aria-label="anchor" href="#the-core-nm-object"></a>
</h3>
<p>The core nm object is created via the <code><a href="../reference/new_nm.html">new_nm()</a></code>. Subsequent child objects are created via the <code><a href="../reference/child.html">child()</a></code> function. All interactions with NONMEM occur through the this object. It contains metadata about the NONMEM run and contain the contents of what will written as the control file (also called model file).</p>
<p>NONMEM control files are only written to the <code>Models</code> sub-directory just before running NONMEM via the <code><a href="../reference/run_nm.html">run_nm()</a></code> command</p>
<p>Let’s create our first NONMEM object with <code><a href="../reference/new_nm.html">new_nm()</a></code>. This will be a parent run to all other runs and thus requires more set up than other runs. Subsequent child objects created with <code><a href="../reference/child.html">child()</a></code> will inherits characteristics of the parent.</p>
<p>Three arguments are required to create the parent, a run identifier, <code>run_id</code>, a control file it’s based on, <code>based_on</code>, and a (relative) dataset path <code>data_path</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span>

<span class="va">m1</span></code></pre></div>
<pre><code><span class="co">## List of 1</span>
<span class="co">##  $ execute.Models/m1</span>
<span class="co">##   ..$ type        : chr "execute"</span>
<span class="co">##   ..$ run_id      : chr "m1"</span>
<span class="co">##   ..$ run_in      : chr "Models"</span>
<span class="co">##   ..$ executed    : logi FALSE</span>
<span class="co">##   ..$ ctl_contents: chr <span style="color: #00BB00;">collapsed - view with ctl_contents()</span></span>
<span class="co">##   ..$ ctl_orig    : chr <span style="color: #00BB00;">collapsed - view with ctl_orig()</span></span>
<span class="co">##   ..$ data_path   : chr "DerivedData/data.csv"</span>
<span class="co">##   ..$ cmd         : chr "execute runm1.mod -dir=m1"</span>
<span class="co">##   ..$ cores       : int 1</span>
<span class="co">##   ..$ parafile    : chr "path/to/parafile.pnm"</span>
<span class="co">##   ..$ run_dir     : chr "m1"</span>
<span class="co">##   ..$ ctl_name    : chr "runm1.mod"</span>
<span class="co">##   ..$ results_dir : chr "Results"</span>
<span class="co">##   ..$ unique_id   : chr "execute.Models/m1"</span>
<span class="co">##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"</span>
<span class="co">##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"</span>
<span class="co">##  - attr(*, "class")= chr [1:2] "nm_list" "list"</span></code></pre>
<p>Display the object by typing <code>m1</code> in the console. Notice that the <code>run_in</code> field is point to <code>Models</code>. This can be changed by piping the function of the same name e.g. </p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"NONMEM/base_model"</span><span class="op">)</span></code></pre></div>
<p>will run all models in a subdirectory of a subdirectory <code>NONMEM/base_model/</code> instead (the $DATA (relative) path to the dataset will be automatically be updated to reflect the new location of the control file). Any field can by modified using a similar heuristic.</p>
<p>Piping is encouraged because it enables you to read the sequence of events in the order that they occur. Here we just have a single pipe, but you’ll see that we will frequently pipe longer chains of commands together. Each step is applying a transformation to the core nm object. The chain can be partially run in the console to see what each transformation is doing. The rest of this document is full of pipes so if you are unfamiliar with pipes, please consult the <code>magrittr</code> documentation.</p>
<p>To extract a field (rather than set a field) use the same function without additional arguments:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "NONMEM/base_model"</span></code></pre>
<p>For now though, we’ll remove the last piped command and stay with the default <code>run_in</code> location.</p>
<p><em>NOTE:</em> the field <code>ctl_name</code> refers to the name of the control that will be created. This will only be created when it the model is run with the <code><a href="../reference/run_nm.html">run_nm()</a></code> function (described later). For now, the control file contents reside inside the object. To view these you can use “show model/ctl file” RStudio ‘Addin’ , or <code>text(m1)</code>.</p>
<p>A few automatic edits from the staged control file and a compact representation of these changes can be shown by highlighting the above code and selecting the “nm_diff” RStudio ‘Addin’ which show what has been changed.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mYUaKrj0-YE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>Learning how to read to diffs will be an important skill in NMproject you will pick up over time. Notice how the <code>$DATA</code> has been updated to refer to the new location.</p>
<p>The default <code><a href="../reference/nm_getsetters.html">cmd()</a></code> field of the object is <code>execute {ctl_name} -dir={run_dir}</code>. The braces are referred to as <code>glue</code> fields using the <code>glue</code> package. These refer to field names of the object that will be substituted in. For completeness on the next step we will explicitly set this to ensure our model development is easy to read.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span></code></pre></div>
<p>The final steps to gets the NONMEM model ready is to fill in the remaining blanks in the template. They are the <code>$INPUT</code> and <code>$THETA</code>, <code>$OMEGA</code>. For this we will use the <code><a href="../reference/fill_input.html">fill_input()</a></code> and <code><a href="../reference/init_theta.html">init_theta()</a></code> and <code><a href="../reference/init_theta.html">init_omega()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/fill_input.html">fill_input</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/init_theta.html">init_sigma</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="executing-nonmem">Executing NONMEM<a class="anchor" aria-label="anchor" href="#executing-nonmem"></a>
</h3>
<p>Thus far, we have not executed NONMEM nor saved the control file to the file system. To execute, we simply pipe into the <code><a href="../reference/run_nm.html">run_nm()</a></code> function which will often form the last step of the chain and then run the command.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/fill_input.html">fill_input</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/init_theta.html">init_sigma</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fast-nmtran-checks">Fast NMTRAN checks<a class="anchor" aria-label="anchor" href="#fast-nmtran-checks"></a>
</h3>
<p>PLACEHOLDER: YouTube video showing “nm_tran” RStudio ‘Addin’ in action.</p>
<p>In a cluster environment it is especially important to be able to diagnose data and control file issues before sending jobs off to the grid. Otherwise, you often need to wait minutes for errors that can be spotted immediately. It’s therefore highly recommended to make use of the “nm_tran” RStudio ‘Addin’. This will only run NMTRAN checks to find control file syntax errors and dataset errors. It will not run NONMEM itself. To use this ‘Addin’, highlight the above code and select the “nm_tran” RStudio ‘Addin’ near the top of the RStudio GUI.</p>
</div>
<div class="section level3">
<h3 id="manual-edits">Manual edits<a class="anchor" aria-label="anchor" href="#manual-edits"></a>
</h3>
<p>Often there will not be the functions to do the control file manipulation you want. Although it is preferable to stick to automatic control file manipulation functions, you can do fully tracked manual edits via the “manual edit” RStudio ‘Addins’ menu. Again, just highlight the code, click the ‘Addin’ and follow the instructions:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HyCHeAAiwy4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>
<div class="section level3">
<h3 id="automatic-edits">Automatic edits<a class="anchor" aria-label="anchor" href="#automatic-edits"></a>
</h3>
<p>NMproject contains several functions for automatic control file edits. We have already seen <code><a href="../reference/fill_input.html">fill_input()</a></code> and <code><a href="../reference/init_theta.html">init_theta()</a></code> etc. There are higher order functions which make multiple changes to your control stream, one of which is the <code><a href="../reference/subroutine.html">subroutine()</a></code>. If we already have a parent run <code>m1</code> using <code>ADVAN2 TRANS1</code>, we can create a <code><a href="../reference/child.html">child()</a></code> run that uses <code>TRANS2</code> using:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/subroutine.html">subroutine</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>View exactly what’s been changed by highlighting the above code in RStudio and clicking the "nm_diff RStudio ‘Addin’ to see what’s been changed before running. Here, changes will be in the <code>$SUB</code>, <code>$PK</code> and <code>$THETA</code>.</p>
<p>To add a covariate using PsN coding conventions use <code><a href="../reference/add_remove_covs.html">add_cov()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2WT</span> <span class="op">&lt;-</span> <span class="va">m2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m2WT"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/add_remove_covs.html">add_cov</a></span><span class="op">(</span>param <span class="op">=</span> <span class="st">"CL"</span>, cov <span class="op">=</span> <span class="st">"WT"</span>, state <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="initial-estimates">Initial estimates<a class="anchor" aria-label="anchor" href="#initial-estimates"></a>
</h3>
<p>We saw a little at how the functions <code>init_theta</code>, <code>init_omega</code> and <code>init_sigma</code> can be used to set initial estimates earlier. The functions actually allow manipulation of initial estimates, parameter bounds, names, units, etc.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## display R representaton of $THETA</span>
<span class="va">it</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">it</span></code></pre></div>
<pre><code><span class="co">##   name parameter lower init upper theta   FIX unit trans line pos orig_line</span>
<span class="co">## 2   KA    THETA1    NA  0.5    NA     1 FALSE  h-1   LOG    2   1         2</span>
<span class="co">## 3    K    THETA2    NA -2.5    NA     2 FALSE  h-1   LOG    3   1         3</span>
<span class="co">## 4    V    THETA3    NA -0.5    NA     3 FALSE    L   LOG    4   1         4</span></code></pre>
<p>Note that the use of <code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">dplyr::first()</a></code> is because <code>init_theta</code> returns a list of a <code>data.frame</code> and since we want to manipulate <code>io</code>, it’s easier if it’s a <code>data.frame</code> or <code>tibble</code> as then we can use R extensive <code>data.frame</code> manipulation functions. We use the same init_theta with the modified <code>tibble</code> to update the nm object like so:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## this is the slower method - only for illustration purposes</span>
<span class="va">it</span><span class="op">$</span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span><span class="va">it</span><span class="op">)</span> 
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 0   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| 1   ; K ; h-1 ; LOG</span>
<span class="co">##   4| 2   ; V ; L ; LOG</span></code></pre>
<p>This is quite inconvenient though as it requires 3 lines of R code. Knowing the columns of the ‘tibble’ though, we can manipulate values directly like so:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Reset in one line to what we set it to earlier</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| -2   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| 0.5   ; K ; h-1 ; LOG</span>
<span class="co">##   4| 1   ; V ; L ; LOG</span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## This however requires knowing the order of parameters</span>
<span class="co">## here we supply a named vector in a different order</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>KA <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, V <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| -2   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| 0.5   ; K ; h-1 ; LOG</span>
<span class="co">##   4| 1   ; V ; L ; LOG</span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## can also manipulate other aspects (like the FIX column) similarly</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>KA <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, V <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                        FIX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>KA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| -2 FIX   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| 0.5   ; K ; h-1 ; LOG</span>
<span class="co">##   4| 1   ; V ; L ; LOG</span></code></pre>
<p>It works similarly for $OMEGA and $SIGMA with init_omega and init_sigma, respectively.</p>
</div>
<div class="section level3">
<h3 id="shiny-run-monitor">Shiny run monitor<a class="anchor" aria-label="anchor" href="#shiny-run-monitor"></a>
</h3>
<p>To view all runs in the workspace and track progress:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shiny_nm.html">shiny_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>PLACEHOLDER: video showing shiny_nm()</p>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>Use markdown templates to create a customised set of diagnostics to reuse on multiple models. In the demo an example is shown in <code>Scripts/basic_gof.Rmd</code>, but ideally you’ll create your own customised version with everything you need to evaluate your model. To create an R markdown diagnostic template go to <code>FILE</code> -&gt; <code>New File</code> -&gt; <code>R markdown</code> -&gt; <code>From Template</code> then select from one of the following:</p>
<ul>
<li><p><code>model diagnostic</code></p></li>
<li><p><code>VPC diagnostic</code></p></li>
<li><p><code>PPC diagnostic</code></p></li>
<li><p><code>bootstrap results</code></p></li>
</ul>
<p><em>PLACEHOLDER: short YouTube video of opening, customising, saving and running a template.</em></p>
<p>A template will appear in the script window for you to customise. Instructions are the at the top. Save the file (e.g. as <code>Scripts/basic_gof.Rmd</code>) and run in your log script with:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span></code></pre></div>
<p>It will create the output in <code>Results</code> (or <code>results_dir(m1)</code>)</p>
<p>Apply a fully editable goodness of fit R markdown template to both runs <code>m2</code> and <code>m3</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span></code></pre></div>
<p>Note: <code>c(m1, m3)</code> is a vector object of 2 NONMEM runs. We’ll touch more on this later.</p>
<p>Evaluate and compare runs on the fly with the following commands</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/rr.html">rr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">m2WT</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##       parameter     type unit trans    nm_name     Models/m2       Models/m2WT</span>
<span class="co">## 1            KA    THETA  h-1   LOG     THETA1   1.5 (21.7%)       1.5 (21.6%)</span>
<span class="co">## 2            CL    THETA  h-1   LOG     THETA2  0.04 (8.33%)    0.0398 (7.83%)</span>
<span class="co">## 3             V    THETA    L   LOG     THETA3 0.461 (4.65%)     0.459 (4.66%)</span>
<span class="co">## 11 TVCLWTlinear    THETA       &lt;NA&gt;     THETA4          &lt;NA&gt; -0.0115 (0.00874)</span>
<span class="co">## 4        IIV_KA OMEGAVAR  CV%   LOG OMEGA.1.1.  80.6 (21.2%)      80.5 (22.5%)</span>
<span class="co">## 5        IIV_CL OMEGAVAR  CV%   LOG OMEGA.2.2.  28.2 (27.9%)      26.1 (34.9%)</span>
<span class="co">## 6         IIV_V OMEGAVAR  CV%   LOG OMEGA.3.3.  12.9 (44.6%)        13 (44.5%)</span>
<span class="co">## 7    prop error    SIGMA   SD  &lt;NA&gt; SIGMA.1.1. 0.141 (10.3%)     0.134 (12.1%)</span>
<span class="co">## 8     add error    SIGMA   SD  &lt;NA&gt; SIGMA.2.2.   0.229 (20%)     0.264 (25.7%)</span>
<span class="co">## 9           OBJ      OBJ       &lt;NA&gt;        OBJ       104.823           102.719</span>
<span class="co">## 10      CONDNUM  CONDNUM       &lt;NA&gt;    CONDNUM      6.63 (0)          7.75 (0)</span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_iter.html">plot_iter</a></span><span class="op">(</span><span class="va">m2</span>, skip <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co">## skip first 10 interations </span></code></pre></div>
<p><img src="NMproject_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/covariance_plot.html">covariance_plot</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span></code></pre></div>
<p><img src="NMproject_files/figure-html/unnamed-chunk-19-2.png" width="700"></p>
<p>However these are better placed inside templates to enable rapid and consistent re-use.</p>
</div>
<div class="section level3">
<h3 id="simulation-based-diagnostics">Simulation based diagnostics<a class="anchor" aria-label="anchor" href="#simulation-based-diagnostics"></a>
</h3>
<p>Create simulation based diagnostics first by running a simulation using <code><a href="../reference/update_parameters.html">update_parameters()</a></code> and <code><a href="../reference/convert_to_simulation.html">convert_to_simulation()</a></code>. Then use the <code>ppc diagnostics</code> and <code>vpc diagnostics</code> R markdown templates to generate customisable VPC and PPC diagnostics reports.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m2s</span> <span class="op">&lt;-</span> <span class="va">m2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m2s"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="../reference/update_parameters.html">update_parameters</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="../reference/convert_to_simulation.html">convert_to_simulation</a></span><span class="op">(</span>subpr <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">m2s</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_vpc.Rmd"</span><span class="op">)</span>
<span class="va">m2s</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_ppc.Rmd"</span><span class="op">)</span></code></pre></div>
<p>Don’t forget to comment your code with your decision making.</p>
</div>
<div class="section level3">
<h3 id="clean-up-runs">Clean up runs<a class="anchor" aria-label="anchor" href="#clean-up-runs"></a>
</h3>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/temp_files.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span> <span class="co">## will list all temporary files associate with run m1</span>

<span class="co">## remove all temporary files associated with m1</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/temp_files.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Not specifying an argument will list temporary files of all runs</span>
<span class="fu"><a href="../reference/temp_files.html">ls_tempfiles</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-nonmem-with-parallel-processing">Running NONMEM with parallel processing<a class="anchor" aria-label="anchor" href="#running-nonmem-with-parallel-processing"></a>
</h3>
<p>Two fields <code>parafile</code> and <code>cores</code> when combined with a suitable <code>cmd</code> can enable runs to be executed in parallel using PsN.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>,
             based_on <span class="op">=</span> <span class="st">"staging/Models/ADVAN2.mod"</span>,
             data_path <span class="op">=</span> <span class="st">"DerivedData/data.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -parafile={parafile} -dir={run_dir} -nodes={cores}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm750/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">cores</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bootstraps">Bootstraps<a class="anchor" aria-label="anchor" href="#bootstraps"></a>
</h3>
<p>The package <code>rsample</code> can be used to create bootstrap datasets in your initial data manipulation scripts. The following is an example bootstrap dataset being prepared with stratification on <code>SEX</code> and bodyweight <code>WTC</code> categorised in two categories</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>WT_C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">WT</span>, breaks <span class="op">=</span> <span class="fl">2</span>, labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
         STRATA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">SEX</span>, <span class="va">WT_C</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>

<span class="va">d_id</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">distinct</span><span class="op">(</span><span class="va">ID</span>, <span class="va">STRATA</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>

<span class="co">## create large set of resamples (to enable simulation to grow without ruining seed)</span>
<span class="va">bootsplits</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/bootstraps.html" class="external-link">bootstraps</a></span><span class="op">(</span><span class="va">d_id</span>, <span class="fl">100</span>, strata <span class="op">=</span> <span class="st">"STRATA"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"DerivedData"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">bootsplits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="st">"DerivedData/bootsplit_data.csv.RData"</span><span class="op">)</span></code></pre></div>
<p>In a model development script, the following, performs a 100 sample bootstrap of model <code>m1</code></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1_boot</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/make_boot_datasets.html">make_boot_datasets</a></span><span class="op">(</span>samples <span class="op">=</span> <span class="fl">100</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">m1_boot</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## the following bootstrap template will wait for results to complete</span>
<span class="va">m1_boot</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_list_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_boot.Rmd"</span><span class="op">)</span></code></pre></div>
<p>Results can be viewed in <code>Results/basic_boot.m1.html</code>.</p>
</div>
<div class="section level3">
<h3 id="stepwise-covariate-selection">Stepwise covariate selection<a class="anchor" aria-label="anchor" href="#stepwise-covariate-selection"></a>
</h3>
<p>The goal of NMproject’s covariate modelling functions is to provide a stepwise covariate method <em>with manual decision</em> making. This important to ensure that the full model selection/evaluation criteria (should be defined in statistical analysis plans) can be applied at every step rather than just log likelihood ratio testing, where the most significant model may be unstable, may worsen model predictions or may only be slightly more significant than a more physiologically plausible covariate relationship.</p>
<p>The functions <code><a href="../reference/test_relations.html">test_relations()</a></code>, <code><a href="../reference/covariate_step_tibble.html">covariate_step_tibble()</a></code>, <code><a href="../reference/bind_covariate_results.html">bind_covariate_results()</a></code> together comprise NMproject stepwise covariate method with manual decision. The goal is to be part way between PsN’s SCM and completely manual process at each forward and backward elimination step. The syntax of how covariates are included is the same as PsN’s SCM routine - See <a href="https://uupharmacometrics.github.io/PsN/docs.html" class="external-link">PsN documentation</a> for more information.</p>
<p>Relationships to tests are defined using the <code><a href="../reference/test_relations.html">test_relations()</a></code> function. Below we test <code>BWT</code> and <code>AGE</code> on all parameters in both <code>linear</code> and <code>power</code> fashion and all parameters are test with the categorical covariate <code>SEX</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_relations.html">test_relations</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"KA"</span>, <span class="st">"K"</span>, <span class="st">"V"</span><span class="op">)</span>,
                        cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BWT"</span>, <span class="st">"AGE"</span><span class="op">)</span>,
                        state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"power"</span><span class="op">)</span>,
                        continuous <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">dtest</span> <span class="op">&lt;-</span> <span class="va">dtest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/test_relations.html">test_relations</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"KA"</span>, <span class="st">"K"</span>, <span class="st">"V"</span><span class="op">)</span>,
                                  cov <span class="op">=</span> <span class="st">"SEX"</span>,
                                  state <span class="op">=</span> <span class="st">"linear"</span>,
                                  continuous <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">dtest</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 15 × 4</span></span>
<span class="co">##    param cov   state  continuous</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>     </span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> KA    BWT   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> K     BWT   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> V     BWT   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> KA    AGE   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> K     AGE   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> V     AGE   linear TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> KA    BWT   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> K     BWT   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> V     BWT   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> KA    AGE   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;">11</span> K     AGE   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;">12</span> V     AGE   power  TRUE      </span>
<span class="co">## <span style="color: #BCBCBC;">13</span> KA    SEX   linear FALSE     </span>
<span class="co">## <span style="color: #BCBCBC;">14</span> K     SEX   linear FALSE     </span>
<span class="co">## <span style="color: #BCBCBC;">15</span> V     SEX   linear FALSE</span></code></pre>
<p>The workflow for forward (and backward) steps then becomes</p>
<ol style="list-style-type: decimal">
<li>create a <code>tibble</code> of runs for the next step with <code><a href="../reference/covariate_step_tibble.html">covariate_step_tibble()</a></code>
</li>
<li>run all with <code><a href="../reference/run_nm.html">run_nm()</a></code>
</li>
<li>collect results with <code><a href="../reference/bind_covariate_results.html">bind_covariate_results()</a></code>
</li>
<li>evaluate top performing runs</li>
<li>Either select a run to take to the next step (go back to step 1) OR stop.</li>
</ol>
<p>Here are steps 1-3 in action:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create tibble of covariate step with model objects as column m</span>
<span class="va">dsm1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/covariate_step_tibble.html">covariate_step_tibble</a></span><span class="op">(</span>
  run_id <span class="op">=</span> <span class="st">"m1_f1"</span>,
  dtest <span class="op">=</span> <span class="va">dtest</span>,
  direction <span class="op">=</span> <span class="st">"forward"</span>
<span class="op">)</span>

<span class="co">## run all models greedily and wait for them to finish</span>
<span class="va">dsm1</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## extract results and put into tibble</span>
<span class="va">dsm1</span> <span class="op">&lt;-</span> <span class="va">dsm1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/bind_covariate_results.html">bind_covariate_results</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Here are steps 4-5: evaluate and select</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## sort by BIC (for example) and view</span>
<span class="va">dsm1</span> <span class="op">&lt;-</span> <span class="va">dsm1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">arrange</span><span class="op">(</span><span class="va">BIC</span><span class="op">)</span>

<span class="co">## check condition number, covariance,...</span>

<span class="co">## run diagnostic reports on the top three</span>
<span class="va">dsm1</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span>
<span class="co">## diagnostic reports will not be in "Results" like other runs</span>
<span class="co">## to see the location, look at the "results_dir" field of the object</span>
<span class="fu"><a href="../reference/nm_getsetters.html">results_dir</a></span><span class="op">(</span><span class="va">dsm1</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>

<span class="co">## In this case we selec the first: dsm1$m[1]</span>
<span class="va">m1_f1</span> <span class="op">&lt;-</span> <span class="va">dsm1</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>   <span class="co">## select most significant BIC</span></code></pre></div>
<p>Do next forward step</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dsm2</span> <span class="op">&lt;-</span> <span class="va">m1_f1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/covariate_step_tibble.html">covariate_step_tibble</a></span><span class="op">(</span>
  run_id <span class="op">=</span> <span class="st">"m1_f2"</span>,
  dtest <span class="op">=</span> <span class="va">dtest</span>,
  direction <span class="op">=</span> <span class="st">"forward"</span>
<span class="op">)</span></code></pre></div>
<p>continue for as many steps as needed.</p>
</div>
<div class="section level3">
<h3 id="perturbing-initial-parameters">Perturbing initial parameters<a class="anchor" aria-label="anchor" href="#perturbing-initial-parameters"></a>
</h3>
<p>To modify initial estimates, we’ll use the <code>mutate</code> like behaviour of <code>init_*</code> functions. We will modify the <code>init</code> by referencing itself. We’ll modified all our fixed effects (log transformed) by 30%</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">init</span>, mean <span class="op">=</span> <span class="va">init</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 1.024   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -2.1535   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.52284   ; V ; L ; LOG</span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">init</span>, min <span class="op">=</span> <span class="va">init</span><span class="op">/</span><span class="fl">2</span>, max <span class="op">=</span> <span class="va">init</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"OMEGA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $OMEGA</span>
<span class="co">##   2| 0.18582   ;  IIV_KA ; LOG</span>
<span class="co">##   3| 0.10566   ;  IIV_K ; LOG</span>
<span class="co">##   4| 0.060302   ;  IIV_V ; LOG</span></code></pre>
</div>
<div class="section level3">
<h3 id="working-with-omegasigma-blocks">Working with $OMEGA/$SIGMA BLOCKS<a class="anchor" aria-label="anchor" href="#working-with-omegasigma-blocks"></a>
</h3>
<p>We can include and remove $OMEGA blocks with the functions <code>block</code> and <code>unblock</code> (to create $OMEGA BLOCKS for correlated random effects).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">io</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="op">)</span>  <span class="co">## note we dont need dplyr::first as block()/unblock() also work on lists of tibbles.</span>
<span class="va">io</span> </code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##     name omega1 omega2 lower     init upper block mblock   FIX unit trans line</span>
<span class="co">## 1   &lt;NA&gt;     NA     NA    NA       NA    NA     1     NA FALSE &lt;NA&gt;  &lt;NA&gt;    1</span>
<span class="co">## 2 IIV_KA      1      1    NA 0.185820    NA     1      1 FALSE &lt;NA&gt;   LOG    2</span>
<span class="co">## 3  IIV_K      2      2    NA 0.105660    NA     2      1 FALSE &lt;NA&gt;   LOG    3</span>
<span class="co">## 4  IIV_V      3      3    NA 0.060302    NA     3      1 FALSE &lt;NA&gt;   LOG    4</span>
<span class="co">##   pos orig_line orig_pos</span>
<span class="co">## 1   1         1        1</span>
<span class="co">## 2   1         2        1</span>
<span class="co">## 3   1         3        1</span>
<span class="co">## 4   1         4        1</span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">io</span> <span class="op">&lt;-</span> <span class="va">io</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/block-omega-sigma.html">block</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>  <span class="co">## make block out ETA 2 and 3</span>

<span class="co">## put modified io wit</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="va">io</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"OMEGA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $OMEGA</span>
<span class="co">##   2| 0.18582   ;   IIV_KA ; LOG</span>
<span class="co">##   3| $OMEGA BLOCK (2)</span>
<span class="co">##   4| 0.10566   ;   IIV_K ; LOG</span>
<span class="co">##   5| 0.01 0.060302   ;   IIV_V ; LOG</span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## for demo purposes we'll reverse the process with unblock()</span>
<span class="va">io</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">io</span> <span class="op">&lt;-</span> <span class="va">io</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/block-omega-sigma.html">unblock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/init_theta.html">init_omega</a></span><span class="op">(</span><span class="va">io</span><span class="op">)</span>
<span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"OMEGA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1`</span>
<span class="co">##   1| $OMEGA</span>
<span class="co">##   2| 0.18582   ;    IIV_KA ; LOG</span>
<span class="co">##   3| 0.10566   ;    IIV_K ; LOG</span>
<span class="co">##   4| 0.060302   ;    IIV_V ; LOG</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<div class="section level3">
<h3 id="vectorisation">Vectorisation<a class="anchor" aria-label="anchor" href="#vectorisation"></a>
</h3>
<p>The basic nm object is fully vectorised. To see this compare the following two outputs</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span></code></pre></div>
<pre><code><span class="co">## List of 1</span>
<span class="co">##  $ execute.Models/m1</span>
<span class="co">##   ..$ type        : chr "execute"</span>
<span class="co">##   ..$ run_id      : chr "m1"</span>
<span class="co">##   ..$ run_in      : chr "Models"</span>
<span class="co">##   ..$ executed    : logi TRUE</span>
<span class="co">##   ..$ ctl_contents: chr <span style="color: #00BB00;">collapsed - view with ctl_contents()</span></span>
<span class="co">##   ..$ ctl_orig    : chr <span style="color: #00BB00;">collapsed - view with ctl_orig()</span></span>
<span class="co">##   ..$ data_path   : chr "DerivedData/data.csv"</span>
<span class="co">##   ..$ cmd         : chr "execute runm1.mod -dir=m1"</span>
<span class="co">##   ..$ cores       : int 1</span>
<span class="co">##   ..$ parafile    : chr "path/to/parafile.pnm"</span>
<span class="co">##   ..$ run_dir     : chr "m1"</span>
<span class="co">##   ..$ ctl_name    : chr "runm1.mod"</span>
<span class="co">##   ..$ results_dir : chr "Results"</span>
<span class="co">##   ..$ unique_id   : chr "execute.Models/m1"</span>
<span class="co">##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"</span>
<span class="co">##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"</span>
<span class="co">##  - attr(*, "class")= chr [1:2] "nm_list" "list"</span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## List of 2</span>
<span class="co">##  $ execute.Models/m1</span>
<span class="co">##   ..$ type        : chr "execute"</span>
<span class="co">##   ..$ run_id      : chr "m1"</span>
<span class="co">##   ..$ run_in      : chr "Models"</span>
<span class="co">##   ..$ executed    : logi TRUE</span>
<span class="co">##   ..$ ctl_contents: chr <span style="color: #00BB00;">collapsed - view with ctl_contents()</span></span>
<span class="co">##   ..$ ctl_orig    : chr <span style="color: #00BB00;">collapsed - view with ctl_orig()</span></span>
<span class="co">##   ..$ data_path   : chr "DerivedData/data.csv"</span>
<span class="co">##   ..$ cmd         : chr "execute runm1.mod -dir=m1"</span>
<span class="co">##   ..$ cores       : int 1</span>
<span class="co">##   ..$ parafile    : chr "path/to/parafile.pnm"</span>
<span class="co">##   ..$ run_dir     : chr "m1"</span>
<span class="co">##   ..$ ctl_name    : chr "runm1.mod"</span>
<span class="co">##   ..$ results_dir : chr "Results"</span>
<span class="co">##   ..$ unique_id   : chr "execute.Models/m1"</span>
<span class="co">##   ..$ lst_path    : chr "m1/NM_run1/psn.lst"</span>
<span class="co">##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"</span>
<span class="co">##  $ execute.Models/m2</span>
<span class="co">##   ..$ type              : chr "execute"</span>
<span class="co">##   ..$ run_id            : chr "m2"</span>
<span class="co">##   ..$ run_in            : chr "Models"</span>
<span class="co">##   ..$ parent_run_id     : chr "m1"</span>
<span class="co">##   ..$ parent_run_in     : chr "Models"</span>
<span class="co">##   ..$ parent_ctl_name   : chr "runm1.mod"</span>
<span class="co">##   ..$ parent_results_dir: chr "Results"</span>
<span class="co">##   ..$ executed          : logi TRUE</span>
<span class="co">##   ..$ ctl_contents      : chr <span style="color: #00BB00;">collapsed - view with ctl_contents()</span></span>
<span class="co">##   ..$ ctl_orig          : chr <span style="color: #00BB00;">collapsed - view with ctl_orig()</span></span>
<span class="co">##   ..$ data_path         : chr "DerivedData/data.csv"</span>
<span class="co">##   ..$ cmd               : chr "execute runm2.mod -dir=m2"</span>
<span class="co">##   ..$ cores             : int 1</span>
<span class="co">##   ..$ parafile          : chr "path/to/parafile.pnm"</span>
<span class="co">##   ..$ run_dir           : chr "m2"</span>
<span class="co">##   ..$ ctl_name          : chr "runm2.mod"</span>
<span class="co">##   ..$ results_dir       : chr "Results"</span>
<span class="co">##   ..$ unique_id         : chr "execute.Models/m2"</span>
<span class="co">##   ..$ lst_path          : chr "m2/NM_run1/psn.lst"</span>
<span class="co">##   ..- attr(*, "class")= chr [1:3] "nm_execute" "nm_generic" "list"</span>
<span class="co">##  - attr(*, "class")= chr [1:2] "nm_list" "list"</span></code></pre>
<p>Both are nm objects with length 1 and 2, respectively. We used the <code>c(m1, m2)</code> above when we wanted to use <code><a href="../reference/nm_render.html">nm_render()</a></code> on both runs. We didn’t need to write any loops or special code to handle this because nm objects and the functions that operate on them have been designed with parallelisation in mind. This is because in pharmacometrics we are often dealing with multiple models, perhaps moreso than other statistical modelling disciplines.</p>
<p>The vectorised nature of the nm object allows groups of runs to be created and run. To demonstrate, lets repeat the the previous initial perturbation exercise, but create 5 runs each with their own perturbed initial estimates.</p>
<p>The basic idea is to start with the parent object <code>m1</code> and then supplying a vector rather than a scalar to the <code><a href="../reference/child.html">child()</a></code> function. Since the <code>rep</code> column is length 5, this will make the nm_object length 5.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1rep</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## start with parent - m1 is length 1</span>
  <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## now object is length = length(1:5) = 5</span>
  <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">init</span>, mean <span class="op">=</span> <span class="va">init</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## vectorised operation</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1rep"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## for tidiness, run these in their own sub-directory</span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="co">## run all 5 runs </span></code></pre></div>
<p>Notice how the functions <code><a href="../reference/init_theta.html">init_theta()</a></code>, <code><a href="../reference/nm_getsetters.html">run_in()</a></code> and <code><a href="../reference/run_nm.html">run_nm()</a></code> all worked on the nm object vector without needing loops.</p>
<p>To see all the $THETAS we can just run</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1rep</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"THETA"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/m1rep/1`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 0.83282   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -2.0818   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.89313   ; V ; L ; LOG</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/m1rep/2`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 0.83168   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -2.4879   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.74175   ; V ; L ; LOG</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/m1rep/3`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 1.3368   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -2.5241   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.2008   ; V ; L ; LOG</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/m1rep/4`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 1.2992   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -1.8925   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.29757   ; V ; L ; LOG</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/m1rep/5`</span>
<span class="co">##   1| $THETA</span>
<span class="co">##   2| 1.5   ; KA ; h-1 ; LOG</span>
<span class="co">##   3| -2.0119   ; K ; h-1 ; LOG</span>
<span class="co">##   4| -0.77542   ; V ; L ; LOG</span></code></pre>
<p>We can also use standard <code>dplyr</code> to embed nm objects in data.frames. This is a useful way to organise groups of runs. E.g. the following would be an alternative way of running the previous lines which isn’t that useful here, but will be useful in the following section.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d1rep</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>rep <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>
    m <span class="op">=</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">rep</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="../reference/init_theta.html">init_theta</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">init</span>, mean <span class="op">=</span> <span class="va">init</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
      <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1rep"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">d1rep</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="automating-model-checking">Automating model checking<a class="anchor" aria-label="anchor" href="#automating-model-checking"></a>
</h3>
<p>Following on from the previous section we will now</p>
<p>Lets expand the earlier subroutine example to build a vector of runs that test multiple different <code>ADVAN</code>s and <code>TRANS</code> at the same time.</p>
<p>We’ll use a similar structure to the previous section using <code>.available_advans</code> to list all available ADVAN/TRANS options, <code>filter</code> to isolate specific ADVAN/TRANS options, and <code>mutate</code> and <code><a href="../reference/subroutine.html">subroutine()</a></code> to perform the control file manipulation function.</p>
<p>Then we’ll display all the <code>$PK</code> subroutines to view the changes.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.available_advans</span> <span class="co">## display available advans</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 20 × 6</span></span>
<span class="co">##    advan trans   cmt oral  params                  label</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span>     1     1     1 FALSE K,V                     a1t1 </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span>     1     2     1 FALSE CL,V                    a1t2 </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span>     2     1     1 TRUE  KA,K,V                  a2t1 </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span>     2     2     1 TRUE  KA,CL,V                 a2t2 </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span>     3     1     2 FALSE K,K12,K21,V             a3t1 </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span>     3     3     2 FALSE CL,Q,V,VSS              a3t3 </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span>     3     4     2 FALSE CL,Q,V1,V2              a3t4 </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span>     4     1     2 TRUE  KA,K,K23,K32,V2         a4t1 </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span>     4     3     2 TRUE  KA,CL,Q,V,VSS           a4t3 </span>
<span class="co">## <span style="color: #BCBCBC;">10</span>     4     4     2 TRUE  KA,CL,Q,V2,V3           a4t4 </span>
<span class="co">## <span style="color: #BCBCBC;">11</span>     5     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a5t1 </span>
<span class="co">## <span style="color: #BCBCBC;">12</span>     6     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a6t1 </span>
<span class="co">## <span style="color: #BCBCBC;">13</span>     7     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a7t1 </span>
<span class="co">## <span style="color: #BCBCBC;">14</span>     8     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a8t1 </span>
<span class="co">## <span style="color: #BCBCBC;">15</span>     9     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a9t1 </span>
<span class="co">## <span style="color: #BCBCBC;">16</span>    11     1     3 FALSE K,K12,K21,K13,K31,V     a11t1</span>
<span class="co">## <span style="color: #BCBCBC;">17</span>    11     4     3 FALSE CL,Q2,V1,V2,Q3,V3       a11t4</span>
<span class="co">## <span style="color: #BCBCBC;">18</span>    12     1     3 TRUE  KA,K,K23,K32,K24,K42,V2 a12t1</span>
<span class="co">## <span style="color: #BCBCBC;">19</span>    12     4     3 TRUE  KA,CL,Q3,V2,V3,Q4,V4    a12t4</span>
<span class="co">## <span style="color: #BCBCBC;">20</span>    13     1    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    KXY,VX                  a13t1</span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">.available_advans</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="co">## filter only for oral dosing advans</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">oral</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="co">## mutate state create a column vector m of nm objects</span>
  <span class="co">## first step is to create children runs from the parent object m1</span>
  <span class="co">## this is done by supplying a vector of run_ids to the child() function</span>
  <span class="fu">mutate</span><span class="op">(</span>m <span class="op">=</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## start with parent m1 again</span>
           <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">label</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## create multiple children using label column</span>
           <span class="fu"><a href="../reference/subroutine.html">subroutine</a></span><span class="op">(</span>advan <span class="op">=</span> <span class="va">advan</span>, trans <span class="op">=</span> <span class="va">trans</span><span class="op">)</span> <span class="co">## set subroutine using advan and trans columns</span>
         <span class="op">)</span>

<span class="co">## view the $PK blocks of each</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/dollar.html">dollar</a></span><span class="op">(</span><span class="st">"PK"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $`execute.Models/a2t1`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVK=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVK)</span>
<span class="co">##   9| K = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV)</span>
<span class="co">##  13| V = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| CL = K*V</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V</span>
<span class="co">##  18| </span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a2t2`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVCL=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVCL)</span>
<span class="co">##   9| CL = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV)</span>
<span class="co">##  13| V = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| ; CL = K*V</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V</span>
<span class="co">##  18| </span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a4t1`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVK=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVK)</span>
<span class="co">##   9| K = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV2=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV2)</span>
<span class="co">##  13| V2 = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| CL = K*V2</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V2</span>
<span class="co">##  18| </span>
<span class="co">##  19| TVK23=EXP(THETA(4))</span>
<span class="co">##  20| MU_4=LOG(TVK23)</span>
<span class="co">##  21| K23 = EXP(MU_4+ETA(4))</span>
<span class="co">##  22| TVK32=EXP(THETA(5))</span>
<span class="co">##  23| MU_5=LOG(TVK32)</span>
<span class="co">##  24| K32 = EXP(MU_5+ETA(5))</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a4t3`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVCL=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVCL)</span>
<span class="co">##   9| CL = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV)</span>
<span class="co">##  13| V = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| ; CL = K*V</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V</span>
<span class="co">##  18| </span>
<span class="co">##  19| TVQ=EXP(THETA(4))</span>
<span class="co">##  20| MU_4=LOG(TVQ)</span>
<span class="co">##  21| Q = EXP(MU_4+ETA(4))</span>
<span class="co">##  22| TVVSS=EXP(THETA(5))</span>
<span class="co">##  23| MU_5=LOG(TVVSS)</span>
<span class="co">##  24| VSS = EXP(MU_5+ETA(5))</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a4t4`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVCL=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVCL)</span>
<span class="co">##   9| CL = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV2=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV2)</span>
<span class="co">##  13| V2 = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| ; CL = K*V</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V2</span>
<span class="co">##  18| </span>
<span class="co">##  19| TVQ=EXP(THETA(4))</span>
<span class="co">##  20| MU_4=LOG(TVQ)</span>
<span class="co">##  21| Q = EXP(MU_4+ETA(4))</span>
<span class="co">##  22| TVV3=EXP(THETA(5))</span>
<span class="co">##  23| MU_5=LOG(TVV3)</span>
<span class="co">##  24| V3 = EXP(MU_5+ETA(5))</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a12t1`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVK=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVK)</span>
<span class="co">##   9| K = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV2=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV2)</span>
<span class="co">##  13| V2 = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| CL = K*V2</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V2</span>
<span class="co">##  18| </span>
<span class="co">##  19| TVK23=EXP(THETA(4))</span>
<span class="co">##  20| MU_4=LOG(TVK23)</span>
<span class="co">##  21| K23 = EXP(MU_4+ETA(4))</span>
<span class="co">##  22| TVK32=EXP(THETA(5))</span>
<span class="co">##  23| MU_5=LOG(TVK32)</span>
<span class="co">##  24| K32 = EXP(MU_5+ETA(5))</span>
<span class="co">##  25| TVK24=EXP(THETA(6))</span>
<span class="co">##  26| MU_6=LOG(TVK24)</span>
<span class="co">##  27| K24 = EXP(MU_6+ETA(6))</span>
<span class="co">##  28| TVK42=EXP(THETA(7))</span>
<span class="co">##  29| MU_7=LOG(TVK42)</span>
<span class="co">##  30| K42 = EXP(MU_7+ETA(7))</span>
<span class="co">## </span>
<span class="co">## $`execute.Models/a12t4`</span>
<span class="co">##   1| $PK</span>
<span class="co">##   2| </span>
<span class="co">##   3| TVKA=EXP(THETA(1))</span>
<span class="co">##   4| MU_1=LOG(TVKA)</span>
<span class="co">##   5| KA = EXP(MU_1+ETA(1))</span>
<span class="co">##   6| </span>
<span class="co">##   7| TVCL=EXP(THETA(2))</span>
<span class="co">##   8| MU_2=LOG(TVCL)</span>
<span class="co">##   9| CL = EXP(MU_2+ETA(2))</span>
<span class="co">##  10| </span>
<span class="co">##  11| TVV2=EXP(THETA(3))</span>
<span class="co">##  12| MU_3=LOG(TVV2)</span>
<span class="co">##  13| V2 = EXP(MU_3+ETA(3))</span>
<span class="co">##  14| </span>
<span class="co">##  15| ; CL = K*V</span>
<span class="co">##  16| </span>
<span class="co">##  17| S2 = V2</span>
<span class="co">##  18| </span>
<span class="co">##  19| TVQ3=EXP(THETA(4))</span>
<span class="co">##  20| MU_4=LOG(TVQ3)</span>
<span class="co">##  21| Q3 = EXP(MU_4+ETA(4))</span>
<span class="co">##  22| TVV3=EXP(THETA(5))</span>
<span class="co">##  23| MU_5=LOG(TVV3)</span>
<span class="co">##  24| V3 = EXP(MU_5+ETA(5))</span>
<span class="co">##  25| TVQ4=EXP(THETA(6))</span>
<span class="co">##  26| MU_6=LOG(TVQ4)</span>
<span class="co">##  27| Q4 = EXP(MU_6+ETA(6))</span>
<span class="co">##  28| TVV4=EXP(THETA(7))</span>
<span class="co">##  29| MU_7=LOG(TVV4)</span>
<span class="co">##  30| V4 = EXP(MU_7+ETA(7))</span></code></pre>
<p>Let’s run these, summarise the results, and generate goodness of fit diagnostics for the ones that gave somewhat reasonable outputs</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run them all and wait for them to finish</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## summarise all runs in a table</span>
<span class="fu"><a href="../reference/nm_summary.html">summary_wide</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">m</span><span class="op">)</span>

<span class="co">## plot goodness of fits for all runs with ofv &lt; 120</span>
<span class="va">dt</span><span class="op">$</span><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu"><a href="../reference/ofv.html">ofv</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">120</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co">## subsetting is a powerful way of isolating functions to particular model objects</span>
  <span class="fu"><a href="../reference/nm_render.html">nm_render</a></span><span class="op">(</span><span class="st">"Scripts/basic_gof.Rmd"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallel-efficiency-test">Parallel efficiency test<a class="anchor" aria-label="anchor" href="#parallel-efficiency-test"></a>
</h3>
<p>Often you’ll want to know the right level of parallelisation to run your model to maximise speed without wasting too many resources. The following creates multiple runes with different levels of parallelisation. We’ll just test it across 1, 3, 10, and 30 cores, but this can be any vector.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span>  <span class="co">## test these levels of parallelisation</span>

<span class="va">m1c</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## start with parent m1 again</span>
  <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">test_cores</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co">## use "cores" as run_id (object is now length 4)</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_coretest"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## for tidiness run them all in m1_coretest</span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"execute {ctl_name} -parafile={parafile} -dir={run_dir} -nodes={cores}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## parallelized execute</span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm75/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">cores</a></span><span class="op">(</span><span class="va">test_cores</span><span class="op">)</span> <span class="co">## and finally set the cores of each models according to test_cores</span>

<span class="va">m1c</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "execute run1.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=1 -nodes=1"   </span>
<span class="co">## [2] "execute run3.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=3 -nodes=3"   </span>
<span class="co">## [3] "execute run10.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=10 -nodes=10"</span>
<span class="co">## [4] "execute run30.mod -parafile=/opt/NONMEM/nm75/run/mpilinux8.pnm -dir=30 -nodes=30"</span></code></pre>
<p>Each run is identical apart from the level of parallelisation</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run them all and wait for them to finish</span>
<span class="va">m1c</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## extract job statistics and plot cores vs Rtime or Ttime to get plots of run</span>
<span class="co">## time and total time vs number of CPUs</span>

<span class="va">m1c</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/job_stats.html">job_stats</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">cores</span>, y <span class="op">=</span> <span class="va">Rtime</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation-re-estimation">Simulation re-estimation<a class="anchor" aria-label="anchor" href="#simulation-re-estimation"></a>
</h3>
<p>There will soon a be a simple wrapper for the code below, as with the bootstrap and step wise covariate functionality above, but for now the code below is a good example of how the flexibility of the vectorised object can be used to create complex workflows whilst still providing granular control of runs.</p>
<p>It’s good advice to start with 1 or 2 replicates and scale up only when you’ve confirmed your code is working (here we’re just using 3 for demo purposes). You will not waste time because <code><a href="../reference/run_nm.html">run_nm()</a></code> will skip over runs that have already completed.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co">## start small, scale up later</span>

<span class="va">dsr</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>sim <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>
    msim <span class="op">=</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>              <span class="co">## start with single parent run, m1, an nm object of length 1</span>
      <span class="fu"><a href="../reference/update_parameters.html">update_parameters</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co">## update inits to finals, here nm object is still length 1</span>
      <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">sim</span>, parent <span class="op">=</span> <span class="va">m1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co">## at this point it becomes length n_sims</span>
      <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_simest"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">## this applies the run_in modification to all n_sims runs</span>
      <span class="fu"><a href="../reference/convert_to_simulation.html">convert_to_simulation</a></span><span class="op">(</span>subpr <span class="op">=</span> <span class="fl">1</span>, seed <span class="op">=</span> <span class="va">sim</span><span class="op">)</span> <span class="co">## converts all to simulation</span>
  <span class="op">)</span>

<span class="co">## run, wait, read results and then write to run_dir paths of simulations</span>
<span class="va">dsr</span><span class="op">$</span><span class="va">msim</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/output_table.html">output_table</a></span><span class="op">(</span>only_append <span class="op">=</span> <span class="st">"DV_OUT"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/write_derived_data.html">write_derived_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/run_dir_path.html">run_dir_path</a></span><span class="op">(</span><span class="va">dsr</span><span class="op">$</span><span class="va">msim</span><span class="op">)</span>, <span class="st">"simdata.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Now create mest column</span>
<span class="va">dsr</span> <span class="op">&lt;-</span> <span class="va">dsr</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>
    mest <span class="op">=</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="va">sim</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="co">## estimations derived from m1</span>
      <span class="fu"><a href="../reference/nm_getsetters.html">run_in</a></span><span class="op">(</span><span class="st">"Models/m1_simest/est"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>   <span class="co">## run in a new subdirectory</span>
      <span class="fu"><a href="../reference/data_path.html">data_path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/run_dir_path.html">run_dir_path</a></span><span class="op">(</span><span class="va">msim</span><span class="op">)</span>, <span class="st">"simdata.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>    <span class="co">## set new data_paths</span>
      <span class="co">## refill $INPUT. Rename DV to be DV_OUT column. Run nm_diff() command below to see</span>
      <span class="co">## what has changed</span>
      <span class="fu"><a href="../reference/fill_input.html">fill_input</a></span><span class="op">(</span>rename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"DV_OBS"</span> <span class="op">=</span> <span class="st">"DV"</span>, <span class="st">"DV"</span> <span class="op">=</span> <span class="st">"DV_OUT"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># nm_diff(dsr$mest[1])</span>

<span class="va">dsr</span><span class="op">$</span><span class="va">mest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/wait_finish.html">wait_finish</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_summary.html">summary_wide</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="faq">FAQ<a class="anchor" aria-label="anchor" href="#faq"></a>
</h2>
<div class="section level4">
<h4 id="i-have-a-pre-prepared-model-and-dataset--whats-the-fastest-way-to-make-an-nm-object-and-make-use-of-the-objects-functionality-for-scripting-post-processing-etc-">+ I have a pre-prepared model and dataset. What’s the fastest way to make an nm object and make use of the objects functionality for scripting, post processing etc.<a class="anchor" aria-label="anchor" href="#i-have-a-pre-prepared-model-and-dataset--whats-the-fastest-way-to-make-an-nm-object-and-make-use-of-the-objects-functionality-for-scripting-post-processing-etc-"></a>
</h4>
<p>Ensure the dataset and model file are somewhere in the project.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_nm.html">new_nm</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1"</span>, 
             based_on <span class="op">=</span> <span class="st">"path/to/control/file"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="after-having-closed-my-session-how-do-i-recreate-my-workspace-and-pick-up-where-i-left-off">+ After having closed my session how do I recreate my workspace and pick up where I left off<a class="anchor" aria-label="anchor" href="#after-having-closed-my-session-how-do-i-recreate-my-workspace-and-pick-up-where-i-left-off"></a>
</h4>
<p>Just re-run all the code again. NONMEM runs that have already been run will not be run again and will instead be retrieved from the cache.</p>
</div>
<div class="section level4">
<h4 id="in-my-organisation-we-have-a-custom-execute-commandwrapper-we-cant-use-the-default-execute-ctl_name--dirrun_dir-how-can-we-change-this">+ In my organisation we have a custom “execute” command/wrapper we can’t use the default <code>execute {ctl_name} -dir={run_dir}</code>, how can we change this?<a class="anchor" aria-label="anchor" href="#in-my-organisation-we-have-a-custom-execute-commandwrapper-we-cant-use-the-default-execute-ctl_name--dirrun_dir-how-can-we-change-this"></a>
</h4>
<p>Two options:</p>
<ol style="list-style-type: decimal">
<li><p>set <code>cmd</code> once for your parent object and then make all other objects child objects from the parent.</p></li>
<li><p>set the default <code>cmd</code> field with <code><a href="../reference/nm_default_fields.html">nm_default_fields()</a></code> for the analysis project for your organisation. E.g. organisations using docker (as described in below FAQ question) require the execute command to be much longer: <code>"docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn execute {ctl_name} -dir={run_dir}"</code>.</p></li>
</ol>
<p><code>nm_default_fields(list(cmd = "docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn execute {ctl_name} -dir={run_dir}"))</code></p>
<p>Setting this will ensure all runs produced in the R session will run using the above command. To see how to set an option for all your R sessions see subsequent question</p>
</div>
<div class="section level4">
<h4 id="how-do-i-set-a-nmproject-configuration-option-permanently-so-i-dont-have-to-set-it-for-all-my-future-r-sessions">+ How do I set a NMproject configuration option permanently so I don’t have to set it for all my future R sessions?<a class="anchor" aria-label="anchor" href="#how-do-i-set-a-nmproject-configuration-option-permanently-so-i-dont-have-to-set-it-for-all-my-future-r-sessions"></a>
</h4>
<p>See <code><a href="https://rdrr.io/r/base/Startup.html" class="external-link">?.Rprofile</a></code>. In a multiple user environment it’s best practice to avoid user specific configurations as your code may run different from user to user. There are two options, set the option for the project or site wide for all users.</p>
<p>To set the option for anyone using the project, include the <code>options</code> command (e.g. <code>options(nm.cmd_default = ....)</code>) in <code>.Rprofile</code>.</p>
<p>To set the option site wide include the <code>options</code> command in <code>$R_HOME/etc/Rprofile.site</code> (requires administration privileges).</p>
<p>Also consider creating your own organisation specific option/path setting package. The <code>options</code> statement then just needs to be in a R script in the packages <code>R</code> directory. Loading this package will then set the option. So be sure to load it (before or after) each time you’re using <code>NMproject</code>. The advantage of a package is you can also bundle other functions in there for them to use.</p>
</div>
<div class="section level4">
<h4 id="how-can-i-contribute-to-the-pmx-code-library">+ How can I contribute to the PMX code library?<a class="anchor" aria-label="anchor" href="#how-can-i-contribute-to-the-pmx-code-library"></a>
</h4>
<p>The repository <code>tsahota/PMXcodelibrary</code> may be discontinued in the future. The current location of the code library is within the NMproject package in the relative path <code>inst/extdata/CodeLibrary</code>. To contribute, either use the pull request functionality of GitHub or send me an email with your change. Make sure you describe the reason for the change so I can ensure it will suit everyone.</p>
</div>
<div class="section level4">
<h4 id="we-already-have-directory-of-rnonmem-scriptstemplates-how-can-we-also-use-these">+ We already have directory of R/NONMEM scripts/templates, how can we also use these?<a class="anchor" aria-label="anchor" href="#we-already-have-directory-of-rnonmem-scriptstemplates-how-can-we-also-use-these"></a>
</h4>
<p>Append your directory location to the <code>code_library_path</code> option.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>code_library_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"code_library_path"</span><span class="op">)</span>,
                              <span class="st">"path/to/existing/repository"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You’ll probably want to set this for all users so see the question above on setting options permanently</p>
</div>
<div class="section level4">
<h4 id="how-do-i-run-this-on-sge">+ How do I run this on SGE?<a class="anchor" aria-label="anchor" href="#how-do-i-run-this-on-sge"></a>
</h4>
<p>There is a pre-prepared built in <code>sge_parallel_execute</code> character object that’s part of NMproject. This uses the grid functionality built into PsN and has been tested to work within the Metworx platform. Simply type it in the console to see the contents. Required fields are <code>parafile</code>, <code>cores</code>. Ensure these are set for your parent object like so.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="va">sge_parallel_execute</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">parafile</a></span><span class="op">(</span><span class="st">"/opt/NONMEM/nm75/run/mpilinux8.pnm"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters_execution.html">cores</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Note that child object will inherit the same <code>cmd</code> structure, <code>cores</code> and <code>parafile</code>.</p>
</div>
<div class="section level4">
<h4 id="how-do-i-run-this-on-other-clusters-like-slurm-lsf-torque">+ How do I run this on other clusters like Slurm, LSF, Torque?<a class="anchor" aria-label="anchor" href="#how-do-i-run-this-on-other-clusters-like-slurm-lsf-torque"></a>
</h4>
<p>The workflow is similar to above where PsN handles the grid submission. You will need to create your own analog character to <code>sge_parallel_execute</code> for your respective cluster. It is recommended to consult PsN documentation to “gridify” your PsN command. Once you have this, it’s just a simple matter of replacing your control file name, run directory, parafile and desired number of cores with the relevant glue field (e.g. <code>{parafile}</code>) and then putting it into your parent <code><a href="../reference/nm_getsetters.html">cmd()</a></code> command to get it running through NMproject.</p>
<p>Feel free to contact me if you need help</p>
</div>
<div class="section level4">
<h4 id="how-do-i-run-nonmem-via-a-psnnonmem-docker-container">+ How do I run NONMEM via a PsN/NONMEM docker container<a class="anchor" aria-label="anchor" href="#how-do-i-run-nonmem-via-a-psnnonmem-docker-container"></a>
</h4>
<p>This requires setting <code><a href="../reference/nm_getsetters.html">cmd()</a></code> field of the first (parent) nm object and also setting <code><a href="../reference/nm_tran_command.html">nm_tran_command()</a></code>.</p>
<p>Easiest way to understand this is via an example: The following assumes the docker container has been set as shown in the fabulous <code>https://github.com/billdenney/Pharmacometrics-Docker</code> repository:</p>
<p>Set cmd for an <code>execute</code> command like so:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn execute {ctl_name} -dir={run_dir}"</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/run_nm.html">run_nm()</a></code> will then execute NONMEM via the docker container. All subsequent child objects will inherit the same command structure. Note the use the gluing object fields <code>ctl_name</code> and <code>run_dir</code> so child objects can inherit the same command structure to save the command being rewritten for each run)</p>
<p>Set up dockerised NMTRAN checking with:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/nm_tran_command.html">nm_tran_command</a></span><span class="op">(</span><span class="st">"docker run --rm --user=$(id -u):$(id -g) -v $(pwd):/data -w /data humanpredictions/psn /bin/bash -c '/opt/NONMEM/nm_current/tr/NMTRAN.exe &lt; {ctl_name}'"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="my-rstudio-server-is-on-a-different-linux-server-to-my-nonmem-cluster--how-can-i-set-up-nmproject-to-work-with-this">+ My RStudio Server is on a different Linux server to my NONMEM cluster. How can I set up NMproject to work with this?<a class="anchor" aria-label="anchor" href="#my-rstudio-server-is-on-a-different-linux-server-to-my-nonmem-cluster--how-can-i-set-up-nmproject-to-work-with-this"></a>
</h4>
<p>You need to ensure your account has passwordless ssh set up. Then create a <code>system_nm</code> option in your <code>~/.Rprofile</code> configuration file which appends an ssh statement to the system call e.g. the following will set you up to connect to the host <code>clustername</code>:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>system_nm<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">cmd</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ssh -q clustername \"cd $(pwd); "</span>,<span class="va">cmd</span>,<span class="st">"\""</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="im-working-on-a-windows-laptop-but-want-to-use-my-nonmem-cluster-for-nonmem-jobs--how-can-i-set-up-nmproject-to-work-with-this">+ I’m working on a windows laptop but want to use my NONMEM cluster for NONMEM jobs. How can I set up NMproject to work with this?<a class="anchor" aria-label="anchor" href="#im-working-on-a-windows-laptop-but-want-to-use-my-nonmem-cluster-for-nonmem-jobs--how-can-i-set-up-nmproject-to-work-with-this"></a>
</h4>
<p>This is not recommended as it requires R working directory being set to a networked drive. This is very slow. If you really want to though consider modifying the <code><a href="../reference/system_nm.html">system_nm()</a></code> option, as in the above FAQ question, to use <code>plink</code> to ssh to the server, change to the relevant working directory and submit a command. This has not been tested however and results are likely to be disappointing.</p>
</div>
<div class="section level4">
<h4 id="my-organisation-has-a-different-control-file-convention-to-the-runxx-mod-convention--can-i-change-this">+ My organisation has a different control file convention to the ‘runXX.mod’ convention. Can I change this?<a class="anchor" aria-label="anchor" href="#my-organisation-has-a-different-control-file-convention-to-the-runxx-mod-convention--can-i-change-this"></a>
</h4>
<p>Set it up with <code>ctl_path</code> the field of your object, e.g. to change the convention to <code>nm.XX.con</code></p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/ctl_path.html">ctl_path</a></span><span class="op">(</span><span class="st">"Models/nm.{run_id}.com"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-submit-a-generic-command-directly-to-the-nonmem-server">+ How do I submit a generic command directly to the NONMEM server?<a class="anchor" aria-label="anchor" href="#how-do-i-submit-a-generic-command-directly-to-the-nonmem-server"></a>
</h4>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/system_nm.html">system_nm</a></span><span class="op">(</span><span class="st">"command_to_run"</span>, dir<span class="op">=</span><span class="st">"path/to/dir"</span><span class="op">)</span></code></pre></div>
<p>if dir is not specified, this will default to the <code>Models</code> directory</p>
</div>
<div class="section level4">
<h4 id="there-is-functionality-in-psns-run-record-sumo-or-pirana-that-i-would-like-but-is-not-available-in-nmproject-">+ There is functionality in PsN’s run record, sumo or Pirana that I would like but is not available in NMproject.<a class="anchor" aria-label="anchor" href="#there-is-functionality-in-psns-run-record-sumo-or-pirana-that-i-would-like-but-is-not-available-in-nmproject-"></a>
</h4>
<p>NMproject doesn’t change PsN’s default directory structure, everything in the “Models” directory is as if you launched the jobs from the command line. Therefore you can continue to use PsN functions on the command line. You can also continue using Pirana by pointing it towards your models directory.</p>
<p>If it’s something you think really should be part of NMproject, open a GitHub “issue” and ask for the feature.</p>
</div>
<div class="section level4">
<h4 id="thats-all-well-and-good-that-nmproject-has-its-own-bootstrapvpc-methods-but-i-just-want-to-runrerun-a-bootstrapvpc-in-psn--can-i-do-this-through-nmproject">+ That’s all well and good that NMproject has it’s own bootstrap/vpc/… methods, but I just want to run/rerun a bootstrap/vpc/… in PsN. Can I do this through NMproject?<a class="anchor" aria-label="anchor" href="#thats-all-well-and-good-that-nmproject-has-its-own-bootstrapvpc-methods-but-i-just-want-to-runrerun-a-bootstrapvpc-in-psn--can-i-do-this-through-nmproject"></a>
</h4>
<p>Yes, just change <code>cmd</code> to reflect the proper PsN command.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1psnboot</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1psnboot"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"bootstrap {ctl_name} -samples=50 -dir={run_dir}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">m1psnvpc</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/child.html">child</a></span><span class="op">(</span>run_id <span class="op">=</span> <span class="st">"m1psnvpc"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/nm_getsetters.html">cmd</a></span><span class="op">(</span><span class="st">"vpc {ctl_name} -samples=50 -dir={run_dir}"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/run_nm.html">run_nm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="i-dont-want-to-use-nmproject-on-my-analysis-project-any-more-can-i-go-back-to-submitting-runs-on-the-command-line">+ I don’t want to use NMproject on my analysis project any more, can I go back to submitting runs on the command line<a class="anchor" aria-label="anchor" href="#i-dont-want-to-use-nmproject-on-my-analysis-project-any-more-can-i-go-back-to-submitting-runs-on-the-command-line"></a>
</h4>
<p>Yes, NMproject has been built to reduce as much as possible the barrier-to-exit to ensure all usage is a voluntary as possible. NMproject doesn’t change PsN’s default directory structure, so you can go back to running PsN via command line or using Pirana etc., at any point.</p>
</div>
<div class="section level4">
<h4 id="i-work-for-a-cro--my-client-doesnt-have-nmproject-or-doesnt-know-to-use-nmproject-how-can-send-the-analysis-to-them-">+ I work for a CRO. My client doesn’t have NMproject or doesn’t know to use NMproject, how can send the analysis to them.<a class="anchor" aria-label="anchor" href="#i-work-for-a-cro--my-client-doesnt-have-nmproject-or-doesnt-know-to-use-nmproject-how-can-send-the-analysis-to-them-"></a>
</h4>
<p>NMproject doesn’t change PsN’s default directory structure, and everything will work for them as long as their version of R (and package versions) are compatible. Your model development log/notebook can still serve as a helpful, human readable process description of your model development steps though. You just need to explain how <code>run_id</code>s correspond to files (e.g. <code>m1</code> corresponds to <code>Models/runm1.mod</code>) so they are able to track what is happening in the model development log to the files on the disk.</p>
<p>If NMproject will be rerun in a different environment consider using <code>renv</code> to ensure package versions remain consistent.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tarj Sahota.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'be93a35b426aba9fa8e576efbb2011e7',
    indexName: 'NMproject',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
